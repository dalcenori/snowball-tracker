<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Autopilot Bills + Snowball Tracker (V3.2 ‚Äî What if?)</title>
  <meta name="theme-color" content="#0b0f19" />
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --muted:#a8b3cf; --text:#eef2ff;
      --accent:#7c5cff; --good:#33d17a; --warn:#ffb020; --bad:#ff4d6d;
      --line:#22304d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #1a2450 0%, var(--bg) 50%);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      position:sticky; top:0; backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,25,.92), rgba(11,15,25,.55));
      border-bottom:1px solid rgba(34,48,77,.55);
      z-index:10;
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12.5px}
    main{padding:14px 16px 96px; max-width:1200px; margin:0 auto}
    .grid{display:grid; gap:12px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns: 1.15fr .85fr} }
    .card{
      background: linear-gradient(180deg, rgba(18,26,42,.92), rgba(18,26,42,.78));
      border:1px solid rgba(34,48,77,.7);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid rgba(34,48,77,.85); background:#0c1324; color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(124,92,255,.95); box-shadow:0 0 0 3px rgba(124,92,255,.2)}
    .btn{
      border:1px solid rgba(124,92,255,.9);
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      color:white; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:900;
    }
    .btn.sm{padding:7px 10px; font-size:12px; border-radius:10px}
    .btn.ghost{background: transparent; border-color: rgba(34,48,77,.95); color: var(--text)}
    .btn.danger{background: linear-gradient(180deg, rgba(255,77,109,.95), rgba(255,77,109,.75)); border-color: rgba(255,77,109,.9)}
    .btn.good{background: linear-gradient(180deg, rgba(51,209,122,.95), rgba(51,209,122,.75)); border-color: rgba(51,209,122,.9)}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(34,48,77,.9);
      color:var(--muted);
    }
    .pill.good{color:#b9ffe0; border-color: rgba(51,209,122,.6); background: rgba(51,209,122,.08)}
    .pill.warn{color:#ffe0a3; border-color: rgba(255,176,32,.6); background: rgba(255,176,32,.08)}
    .pill.bad{color:#ffd0d7; border-color: rgba(255,77,109,.6); background: rgba(255,77,109,.08)}
    .pill.purple{color:#e5dcff; border-color: rgba(124,92,255,.75); background: rgba(124,92,255,.10)}
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1}
    .small{font-size:12px; color:var(--muted)}
    .title{font-weight:900; letter-spacing:.2px}
    .hr{height:1px; background:rgba(34,48,77,.6); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(34,48,77,.55); vertical-align:middle}
    th{color:var(--muted); text-align:left; font-weight:650; font-size:12px}
    .right{text-align:right}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background: linear-gradient(to top, rgba(11,15,25,.95), rgba(11,15,25,.65));
      border-top:1px solid rgba(34,48,77,.55);
      padding:10px 12px;
    }
    .footerbar .wrap{max-width:1200px; margin:0 auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px; color: #d9ddff; background: rgba(124,92,255,.12);
      border: 1px solid rgba(124,92,255,.35); padding: 2px 6px; border-radius: 8px;
    }
    .twoCol{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:620px){ .twoCol{grid-template-columns:1fr 1fr} }
    .chk{transform: scale(1.1);}
    .mini{
      display:block; margin-top:4px; font-size:11px; color:var(--muted); line-height:1.35;
    }
    .badgeSim{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:14px;
      border:1px solid rgba(124,92,255,.7);
      background: rgba(124,92,255,.10);
      color:#efeaff;
      font-weight:900; font-size:12px;
    }
    .deltaPos{color:#b9ffe0}
    .deltaNeg{color:#ffd0d7}
    .snapGrid{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    @media(min-width:760px){ .snapGrid{grid-template-columns:1fr 1fr} }
    .snapBox{
      border:1px solid rgba(34,48,77,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(12,19,36,.45);
    }
    .snapHdr{display:flex; align-items:center; gap:8px}
    .snapHdr b{font-size:13px}
    .snapRow{display:flex; justify-content:space-between; gap:10px; margin-top:8px}
    .snapRow .k{color:var(--muted); font-size:12px}
    .snapRow .v{font-weight:900}
    .simBanner{
      margin-top:10px;
      border:1px solid rgba(124,92,255,.65);
      border-radius:14px;
      padding:10px;
      background: rgba(124,92,255,.10);
    }

    /* Share banner + modal */
    .shareBanner{
      position:sticky;
      top:0;
      z-index:25;
      margin:10px 16px 0;
      border:1px solid rgba(255,176,32,.55);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,176,32,.08);
      backdrop-filter: blur(10px);
    }
    .shareBanner b{color:#ffe0a3}
    .modalBack{
      position:fixed; inset:0; z-index:60;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(18,26,42,.96), rgba(18,26,42,.86));
      border:1px solid rgba(34,48,77,.8);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .qrBox{
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(34,48,77,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(12,19,36,.45);
      overflow:auto;
    }
    .btnline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  </style>
</head>
<body>

<!-- Incoming share banner (only shown when a #share=... link is opened) -->
<div id="incomingShareBanner" class="shareBanner" style="display:none">
  <div class="row">
    <div style="flex:1; min-width:220px">
      <div class="title">Incoming Share Detected</div>
      <div class="small">
        This link contains a saved tracker snapshot. Importing will overwrite <b>THIS device‚Äôs</b> local data.
      </div>
    </div>
    <div class="btnline">
      <button class="btn good sm" id="importShareBtn">Import</button>
      <button class="btn ghost sm" id="ignoreShareBtn">Ignore</button>
    </div>
  </div>
</div>

<header>
  <h1>
    Autopilot Bills + Snowball Tracker <span class="pill">V3.2</span>
    <span id="modePill" class="pill">Reality</span>
    <span class="spacer"></span>
    <button class="btn ghost sm" id="whatIfBtn">What if?</button>
  </h1>
  <div class="sub">Reality stays true. <b>What if?</b> lets you tinker safely side-by-side ‚Äî then Apply if you choose.</div>
</header>

<main class="grid cols2">
  <!-- LEFT -->
  <section class="grid">
    <!-- CURRENT SNAPSHOT -->
    <div class="card">
      <div class="row">
        <div>
          <div class="title">Current Snapshot</div>
          <div class="small">Timeline-based from <b>today</b>. Quick Pay marks items paid for this month and logs it automatically.</div>
        </div>
        <div class="spacer"></div>
        <span id="healthPill" class="pill">Ready</span>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Cash On Hand (right now)</label>
          <input id="cashOnHand" type="number" step="0.01" min="0" placeholder="e.g., 3000.00" />
        </div>
        <div>
          <label>Buffer Floor (don‚Äôt drop below)</label>
          <input id="bufferFloor" type="number" step="0.01" min="0" placeholder="e.g., 1500.00" />
        </div>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Split % used for ‚ÄúSplit Allowed‚Äù bills (planning only)</label>
          <select id="splitPct">
            <option value="1.0">100% (no split)</option>
            <option value="0.9">90%</option>
            <option value="0.8">80%</option>
            <option value="0.7">70%</option>
            <option value="0.6">60%</option>
            <option value="0.5">50% (default)</option>
          </select>
          <div class="small">Affects <b>Committed before next payday</b> + <b>Safe-to-spend</b>, not your actual bill amount.</div>
        </div>
        <div>
          <label>Futurecasting Horizon</label>
          <select id="horizonMonths">
            <option value="1">+1 month</option>
            <option value="2">+2 months</option>
            <option value="3" selected>+3 months</option>
            <option value="4">+4 months</option>
            <option value="6">+6 months</option>
          </select>
          <div class="small">Horizon affects projections in both Reality + What if?</div>
        </div>
      </div>

      <div id="simControls" class="simBanner" style="display:none">
        <div class="row">
          <div class="badgeSim">üü£ What if? mode is ON</div>
          <div class="spacer"></div>
          <button class="btn good sm" id="applySimBtn">Apply to Reality</button>
          <button class="btn ghost sm" id="resetSimBtn">Reset What if?</button>
          <button class="btn danger sm" id="exitSimBtn">Exit What if?</button>
        </div>
        <div class="small" style="margin-top:8px; line-height:1.5">
          Changes here are sandboxed. Reality stays put until you hit <b>Apply to Reality</b>.
        </div>
      </div>

      <!-- Side-by-side snapshot -->
      <div class="snapGrid" style="margin-top:12px">
        <div class="snapBox">
          <div class="snapHdr">
            <b>Reality</b> <span class="pill" style="padding:4px 8px">Anchored</span>
          </div>
          <div class="snapRow"><span class="k">Safe-to-Spend NOW</span><span id="r_safe" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Committed ‚Üí Next Payday</span><span id="r_committed" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Next Payday</span><span id="r_nextpay" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Horizon End</span><span id="r_horizon" class="v mono">$0.00</span></div>
        </div>

        <div class="snapBox">
          <div class="snapHdr">
            <b>What if?</b> <span class="pill purple" style="padding:4px 8px">Sandbox</span>
          </div>
          <div class="snapRow"><span class="k">Safe-to-Spend NOW</span><span id="s_safe" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Committed ‚Üí Next Payday</span><span id="s_committed" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Next Payday</span><span id="s_nextpay" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Horizon End</span><span id="s_horizon" class="v mono">$0.00</span></div>

          <div class="hr"></div>
          <div class="snapRow">
            <span class="k">Delta vs Reality (Horizon)</span>
            <span id="delta_horizon" class="v mono">$0.00</span>
          </div>
          <div class="snapRow">
            <span class="k">Min Payments Freed / mo</span>
            <span id="delta_minfreed" class="v mono">$0.00</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div style="flex:1">
          <div class="small">
            <span class="kbd">Autopilot</span> Next 10 events (running balance) ‚Äî shows <span id="timelineModeLabel">Reality</span>
            <span class="small"> ¬∑ </span>
            <span class="small">Use <span class="kbd">+ Income</span> (bottom bar) to add a one-time deposit for any date.</span>
          </div>
          <div style="margin-top:10px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th class="right">Amount</th>
                  <th class="right">Balance</th>
                  <th class="right">Action</th>
                </tr>
              </thead>
              <tbody id="timelineTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- INCOME + SNOWBALL SETTINGS -->
    <div class="card">
      <div class="row">
        <div class="title">Income + Snowball Settings (one-time)</div>
        <div class="spacer"></div>
        <span class="pill good">Unified</span>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Pay Frequency</label>
          <select id="payFrequency">
            <option value="biweekly">Biweekly (every 14 days)</option>
            <option value="weekly">Weekly (every 7 days)</option>
            <option value="semimonthly">Semi-monthly (15th & last day)</option>
          </select>
        </div>
        <div>
          <label>Paycheck Amount (net)</label>
          <input id="paycheckAmount" type="number" step="0.01" min="0" placeholder="e.g., 1840.80" />
        </div>
        <div>
          <label>Last Payday (date)</label>
          <input id="lastPayday" type="date" />
        </div>
        <div>
          <label>Next Payday (auto)</label>
          <input id="nextPayday" type="date" disabled />
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCol">
        <div>
          <label>Snowball (monthly total)</label>
          <input id="snowballMonthly" type="number" step="0.01" min="0" placeholder="e.g., 600.00" />
          <div class="small">Autopilot allocates it across paychecks or a single day.</div>
        </div>
        <div>
          <label>Snowball Allocation</label>
          <select id="snowballAlloc">
            <option value="per_paycheck">Per Paycheck (split across paychecks)</option>
            <option value="monthly_day">Monthly on Day‚Ä¶</option>
          </select>
          <div class="small" id="allocHelp">Default: split across paychecks.</div>
        </div>
        <div id="snowballDayWrap" style="display:none">
          <label>Snowball Day of Month</label>
          <input id="snowballDay" type="number" min="1" max="31" step="1" placeholder="e.g., 20" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="small" style="line-height:1.55">
        One-time income deposits are now added via the <b>single</b> <span class="kbd">+ Income</span> modal (no more scattered buttons).
      </div>
    </div>

    <!-- BILLS -->
    <div class="card">
      <div class="row">
        <div class="title">Bills (monthly)</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="addBillBtn">+ Add Bill</button>
      </div>
      <div class="small">Mark ‚ÄúSplit Allowed‚Äù if your provider lets you split/extend without disaster.</div>
      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Bill</th>
              <th class="right">Amount</th>
              <th class="right">Due Day</th>
              <th class="right">Split?</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="billsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DEBTS -->
    <div class="card">
      <div class="row">
        <div class="title">Debts (minimums + snowball target)</div>
        <div class="spacer"></div>
        <button class="btn" id="addDebtBtn">+ Add Debt</button>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Target Strategy</label>
          <select id="strategy">
            <option value="snowball">Snowball (smallest balance)</option>
            <option value="avalanche">Avalanche (highest APR)</option>
            <option value="manual">Manual (choose)</option>
          </select>
        </div>
        <div>
          <label>Manual Target (if Manual)</label>
          <select id="manualTarget"></select>
        </div>
      </div>

      <div class="small" style="margin-top:8px">Debt min due day optional. If blank, assumes end-of-month.</div>

      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Debt</th>
              <th class="right">Balance</th>
              <th class="right">APR</th>
              <th class="right">Min</th>
              <th class="right">Due</th>
              <th class="right">Paid Off</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="debtsTbody"></tbody>
        </table>
      </div>

      <div id="payoffBox" class="small" style="margin-top:12px"></div>
    </div>

    <!-- QUICK ADJUSTMENTS -->
    <div class="card">
      <div class="row">
        <div class="title">Adjustments (one-offs)</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="addAdjBtn">+ Add Adjustment</button>
      </div>
      <div class="small">Reality log: surprise bill, extra payment, refund, paid early, etc.</div>

      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Note</th>
              <th class="right">Amount</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="adjTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="grid">
    <div class="card">
      <div class="title">Autopilot Rules (simple)</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        ‚Ä¢ You input bills/debts/income once.<br>
        ‚Ä¢ Daily, update only <b>Cash On Hand</b> (optional) and use <b>Quick Pay</b> when you pay something.<br>
        ‚Ä¢ Split Allowed bills reduce ‚ÄúCommitted before next payday‚Äù using the Split %.
      </div>
    </div>

    <div class="card">
      <div class="title">What if? Playground (fast)</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        In <b>What if?</b> mode, use the <b>SIM</b> buttons in Debts to test:<br>
        ‚Ä¢ payoff one debt<br>
        ‚Ä¢ throw extra at a balance<br>
        ‚Ä¢ see min payments freed + horizon delta<br><br>
        Then hit <b>Apply to Reality</b> if you want to commit.
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn ghost sm" id="simOneOffBtn">+ One-time (SIM)</button>
        <button class="btn ghost sm" id="simWorkPlanBtn">Work Plan (SIM)</button>
      </div>
      <div class="small" style="margin-top:10px">These only change the sandbox while What if? is ON.</div>
    </div>

    <div class="card">
      <div class="title">Quick Actions</div>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <button class="btn ghost" id="importBtn">Import JSON</button>
        <button class="btn ghost" id="createLinkBtn">Create Link</button>
        <button class="btn ghost" id="copyLinkBtn">Copy Link</button>
        <button class="btn ghost" id="createQrBtn">Create QR</button>
        <button class="btn ghost" id="clearLinkBtn">Clear</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div style="grid-column:1/-1">
          <label>Share Link (local snapshot)</label>
          <input id="shareLink" class="mono" readonly placeholder="Tap Create Link‚Ä¶" />
          <div class="small" style="margin-top:6px">
            Share Link / QR encodes your current Reality data into the URL hash. It does <b>not</b> upload anything.
          </div>
        </div>
      </div>

      <input id="fileInput" type="file" accept="application/json" style="display:none" />
      <div class="small" style="margin-top:10px">Export/Import moves your data between devices. It does <b>not</b> publish anything.</div>
    </div>

    <div class="card">
      <div class="title">NFC Use</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        Write your GitHub Pages URL onto an NFC tag.
        <br><span class="kbd">Privacy</span> Everything saves on-device (localStorage). No bank logins.
      </div>
    </div>
  </aside>
</main>

<div class="footerbar">
  <div class="wrap">
    <button class="btn sm" id="addIncomeBtn">+ Income</button>
    <span class="pill good">Split Bills</span>
    <span class="pill">Quick Pay</span>
    <span class="pill purple">What if?</span>
    <span class="pill warn">Local-only</span>
    <div class="spacer"></div>
    <span class="small">V3.2 ‚Äî Reality + What if? (side-by-side)</span>
  </div>
</div>

<!-- QR Modal -->
<div id="qrBack" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row">
      <div class="title">Share QR</div>
      <div class="spacer"></div>
      <button class="btn ghost sm" id="closeQrBtn">Close</button>
    </div>
    <div class="small" style="margin-top:8px; line-height:1.5">
      Scan this on your SmartBoard/device to open the tracker with an <b>optional</b> Import prompt.
    </div>
    <div class="qrBox" style="margin-top:10px">
      <canvas id="qrCanvas" width="320" height="320" style="max-width:100%; height:auto"></canvas>
    </div>
    <div class="small" style="margin-top:10px">
      Tip: if your snapshot is huge, the share link may get too long. In that case, use <b>Export JSON</b> instead.
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div id="incomeBack" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row">
      <div class="title">Add Income (one-time)</div>
      <div class="spacer"></div>
      <button class="btn ghost sm" id="closeIncomeBtn">Close</button>
    </div>
    <div class="small" style="margin-top:8px; line-height:1.5">
      Adds a one-time income deposit as an Adjustment.
      <span class="kbd">Reality</span> affects real totals. <span class="kbd">What if?</span> stays sandboxed.
    </div>

    <div class="twoCol" style="margin-top:10px">
      <div>
        <label>Amount</label>
        <input id="incomeAmt" type="number" step="0.01" min="0" placeholder="e.g., 250.00" />
      </div>
      <div>
        <label>Date</label>
        <input id="incomeDate" type="date" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Note (optional)</label>
      <input id="incomeNote" type="text" placeholder="e.g., Side gig, refund, bonus‚Ä¶" />
      <div class="mini">Tip: leave blank to use ‚ÄúIncome‚Äù.</div>
    </div>

    <div class="hr"></div>

    <div class="btnline" style="justify-content:flex-end">
      <button class="btn ghost" id="cancelIncomeBtn">Cancel</button>
      <button class="btn good" id="saveIncomeBtn">Add</button>
    </div>
  </div>
</div>

<script>
  // ---------- Utils ----------
  const $ = (id) => document.getElementById(id);
  const money = (n) => (Number(n||0)).toLocaleString(undefined, {style:"currency", currency:"USD"});
  const clamp = (v) => Number.isFinite(v) ? v : 0;

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // Dates (local noon avoids DST weirdness)
  function todayNoon(){
    const d = new Date();
    d.setHours(12,0,0,0);
    return d;
  }
  function parseDateInput(v){
    if(!v) return null;
    const [y,m,d] = v.split("-").map(Number);
    if(!y||!m||!d) return null;
    return new Date(y, m-1, d, 12,0,0,0);
  }
  function fmtDateInput(d){
    if(!(d instanceof Date)) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDays(d, days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate()+days);
    return x;
  }
  function endOfMonth(d){
    return new Date(d.getFullYear(), d.getMonth()+1, 0, 12,0,0,0);
  }
  function addMonthsKeepDay(d, months){
    const x = new Date(d.getTime());
    const day = x.getDate();
    x.setMonth(x.getMonth()+months);
    if(x.getDate() !== day){
      x.setDate(0);
      x.setHours(12,0,0,0);
    }
    x.setHours(12,0,0,0);
    return x;
  }

  // ---------- Storage ----------
  // ‚úÖ SAME KEY (backwards compatible)
  const KEY = "autopilot_snowball_v3_2";

  const defaultState = {
    meta:{
      cashOnHand:0,
      bufferFloor:0,
      splitPct:0.5,
      payFrequency:"biweekly",
      paycheckAmount:0,
      lastPayday:"",
      snowballMonthly:0,
      snowballAlloc:"per_paycheck",
      snowballDay:20,
      strategy:"snowball",
      manualTargetId:null,
      // kept for backwards compat (no longer used by UI)
      quickIncome: 100
    },
    bills:[], // {id,name,amount,dueDay,splitAllowed}
    debts:[], // {id,name,balance,apr,min,dueDay,paidOff}
    adjustments:[], // {id,date,note,amount}
    paidCycles:{} // map cycleKey -> true (prevents double-counting after Quick Pay)
  };

  let state = loadState();

  const sim = {
    enabled:false,
    state:null, // deep clone of state
  };

  function deepClone(obj){
    try{ return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj)); }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return deepClone(defaultState);
      const p = JSON.parse(raw);
      return normalizeState(p);
    } catch {
      return deepClone(defaultState);
    }
  }

  function normalizeState(p){
    const merged = {
      meta:{...defaultState.meta, ...(p.meta||{})},
      bills:Array.isArray(p.bills)?p.bills:[],
      debts:Array.isArray(p.debts)?p.debts:[],
      adjustments:Array.isArray(p.adjustments)?p.adjustments:[],
      paidCycles: (p.paidCycles && typeof p.paidCycles==="object") ? p.paidCycles : {}
    };
    merged.meta.quickIncome = Number(merged.meta.quickIncome);
    if(!Number.isFinite(merged.meta.quickIncome) || merged.meta.quickIncome < 0) merged.meta.quickIncome = defaultState.meta.quickIncome;
    return merged;
  }

  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function activeState(){ return sim.enabled ? sim.state : state; }

  // ---------- Paycheck schedule ----------
  function nextPaydayFrom(lastPaydayStr, freq){
    const last = parseDateInput(lastPaydayStr);
    if(!last) return null;
    const now = todayNoon();

    if(freq==="weekly"){
      let nxt = addDays(last, 7);
      while(nxt < now) nxt = addDays(nxt, 7);
      return nxt;
    }
    if(freq==="biweekly"){
      let nxt = addDays(last, 14);
      while(nxt < now) nxt = addDays(nxt, 14);
      return nxt;
    }
    // semi-monthly: 15th & last day
    const y = now.getFullYear(), m = now.getMonth();
    const fifteenth = new Date(y, m, 15, 12,0,0,0);
    const monthEnd = endOfMonth(now);
    if(now < fifteenth) return fifteenth;
    if(now < monthEnd) return monthEnd;
    const nm = new Date(y, m+1, 1, 12,0,0,0);
    return new Date(nm.getFullYear(), nm.getMonth(), 15, 12,0,0,0);
  }

  function generatePaychecks(st, startDate, endDate){
    const freq = st.meta.payFrequency;
    const amt = clamp(st.meta.paycheckAmount);
    const last = parseDateInput(st.meta.lastPayday);
    if(!last || amt<=0) return [];

    let next = nextPaydayFrom(st.meta.lastPayday, freq);
    if(!next) return [];

    const checks = [];
    if(freq==="semimonthly"){
      let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1, 12,0,0,0);
      while(cursor <= endDate){
        const fif = new Date(cursor.getFullYear(), cursor.getMonth(), 15, 12,0,0,0);
        const eom = endOfMonth(cursor);
        [fif, eom].forEach(d=>{
          if(d >= startDate && d <= endDate && d >= next) checks.push({date:d, amount:amt, label:"Paycheck"});
        });
        cursor = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1, 12,0,0,0);
      }
      return checks.sort((a,b)=>a.date-b.date);
    }

    let d = new Date(next.getTime());
    while(d <= endDate){
      if(d >= startDate) checks.push({date:new Date(d.getTime()), amount:amt, label:"Paycheck"});
      d = addDays(d, freq==="weekly" ? 7 : 14);
    }
    return checks;
  }

  // ---------- Targets ----------
  function chooseTargetId(st){
    const active = st.debts.filter(d=>!d.paidOff);
    if(active.length===0) return null;

    const strat = st.meta.strategy;
    if(strat==="manual" && st.meta.manualTargetId){
      const found = active.find(d=>d.id===st.meta.manualTargetId);
      if(found) return found.id;
    }
    if(strat==="avalanche"){
      active.sort((a,b)=> clamp(b.apr)-clamp(a.apr) || clamp(a.balance)-clamp(b.balance));
      return active[0].id;
    }
    active.sort((a,b)=> clamp(a.balance)-clamp(b.balance) || clamp(b.apr)-clamp(a.apr));
    return active[0].id;
  }

  function updateManualTargets(){
    const st = activeState();
    const sel = $("manualTarget");
    sel.innerHTML = "";
    const debts = st.debts.filter(d=>!d.paidOff);
    const opt = document.createElement("option");
    opt.value="";
    opt.textContent = debts.length ? "Select target‚Ä¶" : "No active debts";
    sel.appendChild(opt);

    debts.forEach(d=>{
      const o = document.createElement("option");
      o.value=d.id;
      o.textContent = `${d.name} (${money(d.balance)})`;
      sel.appendChild(o);
    });
    sel.value = st.meta.manualTargetId || "";
  }

  // ---------- Paid-cycle keys ----------
  function cycleKey(type, refId, date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${type}:${refId}:${y}-${m}`;
  }
  function isPaid(st, type, refId, date){
    return !!st.paidCycles[cycleKey(type, refId, date)];
  }
  function markPaid(st, type, refId, date){
    st.paidCycles[cycleKey(type, refId, date)] = true;
  }

  // ---------- Timeline event generation ----------
  function billEventDateForMonth(year, monthIndex, dueDay){
    const d = new Date(year, monthIndex, dueDay, 12,0,0,0);
    if(d.getMonth() !== monthIndex) return null;
    return d;
  }

  function generateMonthlyEvents(st, startDate, endDate){
    const events = [];
    let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1, 12,0,0,0);

    while(cursor <= endDate){
      const y = cursor.getFullYear(), m = cursor.getMonth();

      // bills
      st.bills.forEach(b=>{
        const dueDay = Number(b.dueDay);
        if(!dueDay) return;
        const date = billEventDateForMonth(y,m,dueDay);
        if(!date) return;
        if(date >= startDate && date <= endDate){
          if(isPaid(st, "bill", b.id, date)) return;
          events.push({
            date, type:"bill", refId:b.id,
            label:`Bill: ${b.name}${b.splitAllowed ? " (Split Allowed)" : ""}`,
            amount:-clamp(b.amount),
            splitAllowed: !!b.splitAllowed
          });
        }
      });

      // debt minimums
      st.debts.filter(d=>!d.paidOff).forEach(d=>{
        const dueDay = Number(d.dueDay);
        const date = dueDay ? billEventDateForMonth(y,m,dueDay) : endOfMonth(new Date(y,m,1,12,0,0,0));
        if(!date) return;
        if(date >= startDate && date <= endDate){
          if(isPaid(st, "min", d.id, date)) return;
          events.push({
            date, type:"min", refId:d.id,
            label:`Min: ${d.name}`,
            amount:-clamp(d.min)
          });
        }
      });

      cursor = new Date(y, m+1, 1, 12,0,0,0);
    }

    // adjustments (one-offs)
    st.adjustments.forEach(a=>{
      const date = parseDateInput(a.date);
      if(!date) return;
      if(date >= startDate && date <= endDate){
        events.push({date, type:"adj", refId:a.id, label:`Adj: ${a.note}`, amount:clamp(a.amount)});
      }
    });

    return events;
  }

  function generateSnowballEvents(st, startDate, endDate, paychecks){
    const events = [];
    const monthly = clamp(st.meta.snowballMonthly);
    if(monthly <= 0) return events;

    const alloc = st.meta.snowballAlloc;

    if(alloc === "monthly_day"){
      const day = Math.max(1, Math.min(31, Number(st.meta.snowballDay)||20));
      const now = todayNoon();
      const date = billEventDateForMonth(now.getFullYear(), now.getMonth(), day);
      if(date && date >= startDate && date <= endDate){
        if(!isPaid(st, "snowball", "monthly", date)){
          const targetId = chooseTargetId(st);
          const targetName = targetId ? (st.debts.find(d=>d.id===targetId)?.name || "Target") : "Target";
          events.push({date, type:"snowball", refId:"monthly", label:`Snowball ‚Üí ${targetName}`, amount:-monthly});
        }
      }
      return events;
    }

    // per paycheck split
    const checksInRange = paychecks.filter(p=>p.date >= startDate && p.date <= endDate);
    if(checksInRange.length === 0) return events;

    const per = monthly / checksInRange.length;
    const targetId = chooseTargetId(st);
    const targetName = targetId ? (st.debts.find(d=>d.id===targetId)?.name || "Target") : "Target";

    checksInRange.forEach(p=>{
      const ref = "percheck:"+fmtDateInput(p.date);
      if(isPaid(st, "snowball", ref, p.date)) return;
      events.push({date: p.date, type:"snowball", refId:ref, label:`Snowball ‚Üí ${targetName}`, amount:-per});
    });

    return events;
  }

  function buildTimeline(st, horizonEndDate){
    const start = todayNoon();
    const end = horizonEndDate;

    const paychecks = generatePaychecks(st, start, end);
    const paycheckEvents = paychecks.map(p=>({date:p.date, type:"income", refId:"income:"+fmtDateInput(p.date), label:p.label, amount:clamp(p.amount)}));

    const monthlyEvents = generateMonthlyEvents(st, start, end);
    const snowballEvents = generateSnowballEvents(st, start, end, paychecks);

    const all = [...paycheckEvents, ...monthlyEvents, ...snowballEvents]
      .sort((a,b)=> a.date - b.date || a.type.localeCompare(b.type));

    return {start, end, paychecks, events: all};
  }

  // ---------- Snapshot calculations ----------
  function computeSnapshot(st, horizonEndDate){
    const {events} = buildTimeline(st, horizonEndDate);
    const cash = clamp(st.meta.cashOnHand);
    const buffer = clamp(st.meta.bufferFloor);
    const splitPct = clamp(st.meta.splitPct);

    const nextPay = nextPaydayFrom(st.meta.lastPayday, st.meta.payFrequency);

    // committed before next payday (planning) ‚Äî uses Split % for splitAllowed bills
    let committed = 0;
    if(nextPay){
      events.forEach(ev=>{
        if(ev.date <= nextPay && ev.amount < 0){
          let add = -ev.amount;
          if(ev.type==="bill" && ev.splitAllowed) add = add * splitPct;
          committed += add;
        }
      });
    }

    const safe = cash - buffer - committed;

    // Running balance
    let bal = cash;
    const running = events.map(ev=>{
      bal += ev.amount;
      return {...ev, balance: bal};
    });

    // Balance up to next payday date
    let balAtNextPay = cash;
    if(nextPay){
      events.forEach(ev=>{
        if(ev.date <= nextPay) balAtNextPay += ev.amount;
      });
    }

    // Horizon end
    let balHorizon = cash;
    events.forEach(ev=>{ balHorizon += ev.amount; });

    return { nextPay, committed, safe, running, balAtNextPay, balHorizon };
  }

  function horizonEndDateFromUI(){
    const m = Number($("horizonMonths").value||3);
    const d = todayNoon();
    const endMonth = endOfMonth(addMonthsKeepDay(d, m-1));
    return endMonth;
  }

  // ---------- Payoff estimate (simple) ----------
  function payoffEstimateText(st){
    const active = st.debts.filter(d=>!d.paidOff);
    const monthlyExtra = clamp(st.meta.snowballMonthly);
    if(active.length===0) return "All debts marked paid off. üéâ";
    const mins = active.reduce((a,d)=> a + clamp(d.min), 0);
    const total = active.reduce((a,d)=> a + clamp(d.balance), 0);
    const pay = mins + monthlyExtra;
    if(pay <= 0) return "Add minimum payments (and optional snowball) to estimate payoff.";
    const roughMonths = Math.ceil(total / Math.max(1, pay)); // rough, ignores interest
    const years = Math.floor(roughMonths/12), rem = roughMonths%12;
    const pretty = years>0 ? `${years}y ${rem}m` : `${rem}m`;
    return `Rough payoff pace (ignores interest): <b>${pretty}</b> at ~${money(pay)}/month toward debt.`;
  }

  // ---------- Interest helper line ----------
  function interestLine(d){
    const bal = clamp(d.balance);
    const apr = clamp(d.apr);
    const min = clamp(d.min);
    if(bal<=0 || apr<=0) return `<span class="mini">Est. interest this month: ${money(0)} ¬∑ Min to principal: ${money(min)}</span>`;
    const interest = bal * (apr/100) / 12;
    const principal = Math.max(0, min - interest);
    const warn = principal <= 0 ? ` ¬∑ <span style="color:#ffe0a3">‚ö† min barely touches principal</span>` : "";
    return `<span class="mini">Est. interest this month: ${money(interest)} ¬∑ Min to principal: ${money(principal)}${warn}</span>`;
  }

  // ---------- Quick Pay / Pay Early ----------
  function quickPay(st, ev){
    const today = todayNoon();
    const dateStr = fmtDateInput(today);

    st.adjustments.push({
      id: uid(),
      date: dateStr,
      note: `Quick Paid ‚Äî ${ev.label}${sim.enabled ? " (SIM)" : ""}`,
      amount: ev.amount
    });

    markPaid(st, ev.type, ev.refId, ev.date);
  }

  function payBillEarly(st, billId){
    const b = st.bills.find(x=>x.id===billId);
    if(!b) return;
    const today = todayNoon();

    // one-click: apply payment now, mark this bill paid for this month
    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(today),
      note: `Paid Early ‚Äî Bill: ${b.name}${sim.enabled ? " (SIM)" : ""}`,
      amount: -clamp(b.amount)
    });

    // mark as paid for this month using the bill's actual due-date month key
    const dueDay = Number(b.dueDay) || today.getDate();
    const dueDate = billEventDateForMonth(today.getFullYear(), today.getMonth(), dueDay) || today;
    markPaid(st, "bill", b.id, dueDate);
  }

  // ---------- Add Income modal (single source of truth) ----------
  function openIncomeModal(prefillDate){
    const d = prefillDate instanceof Date ? prefillDate : todayNoon();
    $("incomeAmt").value = "";
    $("incomeDate").value = fmtDateInput(d);
    $("incomeNote").value = "";
    $("incomeBack").style.display = "flex";
    setTimeout(()=>{ try{$("incomeAmt").focus();}catch{} }, 0);
  }
  function closeIncomeModal(){
    $("incomeBack").style.display = "none";
  }
  function addIncomeFromModal(){
    const st = activeState();
    const amt = Number($("incomeAmt").value);
    const dateStr = ($("incomeDate").value||"").trim();
    const noteRaw = ($("incomeNote").value||"").trim();

    if(!Number.isFinite(amt) || amt <= 0){
      alert("Enter a positive income amount.");
      return;
    }
    if(!parseDateInput(dateStr)){
      alert("Pick a valid date.");
      return;
    }

    const note = noteRaw ? noteRaw : "Income";
    st.adjustments.push({
      id: uid(),
      date: dateStr,
      note: `${note}${sim.enabled ? " (SIM)" : ""}`,
      amount: amt
    });

    closeIncomeModal();
    render();
  }

  // ---------- What if? Simulation helpers ----------
  function enterWhatIf(){
    if(sim.enabled) return;
    sim.enabled = true;
    sim.state = deepClone(state);
  }
  function exitWhatIf(){
    sim.enabled = false;
    sim.state = null;
  }
  function resetWhatIf(){
    if(!sim.enabled) return;
    sim.state = deepClone(state);
  }
  function applyWhatIf(){
    if(!sim.enabled) return;
    state = deepClone(sim.state);
    saveState();
    exitWhatIf();
  }
  function ensureSimOn(){
    if(!sim.enabled){
      alert("Turn on What if? first (top-right).");
      return false;
    }
    return true;
  }

  function simAddOneOff(){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const date = prompt("SIM one-time date (YYYY-MM-DD):", fmtDateInput(todayNoon()));
    if(date===null) return;
    const note = prompt("SIM note:", "What if? one-time");
    if(note===null) return;
    const amt = prompt("SIM amount (positive=in, negative=out):", "");
    if(amt===null) return;

    st.adjustments.push({
      id: uid(),
      date: date.trim(),
      note: (note.trim() || "What if? one-time") + " (SIM)",
      amount: Number(amt)||0
    });
  }

  function simWorkPlan(){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const pick = prompt(
`Work Plan (SIM) ‚Äî enter 80 / 100 / 120, or type a paycheck amount:
- 80 hrs example: 1391.31
- 100 hrs example: 1840.80
- 120 hrs example: 2386.60

Type: 80, 100, 120, or a custom paycheck net.`,
"100"
    );
    if(pick===null) return;
    const v = pick.trim();
    const map = { "80":1391.31, "100":1840.80, "120":2386.60 };
    const amt = map[v] ?? Number(v);
    if(!Number.isFinite(amt) || amt<=0){
      alert("Invalid input. Use 80/100/120 or a positive number.");
      return;
    }
    st.meta.paycheckAmount = amt;
  }

  function simPayoffDebt(debtId){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const d = st.debts.find(x=>x.id===debtId);
    if(!d) return;
    if(d.paidOff || clamp(d.balance)<=0){
      alert("That debt is already paid off (SIM).");
      return;
    }
    const cashCost = clamp(d.balance);
    const ok = confirm(`SIM Payoff now?\n\n${d.name}\nPay: ${money(cashCost)}\nThis will (SIM) remove its minimum from the timeline.`);
    if(!ok) return;

    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(todayNoon()),
      note: `Paid off ${d.name} (SIM)`,
      amount: -cashCost
    });
    d.balance = 0;
    d.paidOff = true;
  }

  function simExtraToDebt(debtId){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const d = st.debts.find(x=>x.id===debtId);
    if(!d) return;
    if(d.paidOff || clamp(d.balance)<=0){
      alert("That debt is already paid off (SIM).");
      return;
    }
    const amtStr = prompt(`Extra payment to "${d.name}" (SIM).\nEnter amount:`, "100");
    if(amtStr===null) return;
    const amt = Number(amtStr);
    if(!Number.isFinite(amt) || amt<=0){
      alert("Enter a positive number.");
      return;
    }
    const pay = Math.min(amt, clamp(d.balance));
    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(todayNoon()),
      note: `Extra to ${d.name} (SIM)`,
      amount: -pay
    });
    d.balance = Math.max(0, clamp(d.balance) - pay);
    if(d.balance === 0) d.paidOff = true;
  }

  // ---------- Share link + QR (Reality only) ----------
  function base64UrlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function base64UrlDecode(b64url){
    let s = b64url.replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    const str = decodeURIComponent(escape(atob(s)));
    return str;
  }
  function getShareFromHash(){
    const h = (location.hash || "").slice(1);
    if(!h) return null;
    const parts = h.split("&");
    for(const p of parts){
      const [k,v] = p.split("=");
      if(k === "share" && v) return v;
    }
    return null;
  }
  function clearShareHash(){
    history.replaceState(null, document.title, location.pathname + location.search);
  }
  function buildShareLinkFromState(st){
    const payload = JSON.stringify(st);
    const enc = base64UrlEncode(payload);
    const base = location.origin + location.pathname + location.search;
    return `${base}#share=${enc}`;
  }

  // ---- Tiny QR generator (canvas) ----
  function drawPseudoQR(canvas, text){
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0c1324";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const img = new Image();
    const url = "https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=" + encodeURIComponent(text);
    img.crossOrigin = "anonymous";
    img.onload = ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.onerror = ()=>{
      ctx.fillStyle = "#eef2ff";
      ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("QR failed to load.", 18, 40);
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Use Copy Link or Export JSON.", 18, 64);
    };
    img.src = url;
  }

  function openQrModal(link){
    $("qrBack").style.display = "flex";
    drawPseudoQR($("qrCanvas"), link);
  }
  function closeQrModal(){
    $("qrBack").style.display = "none";
  }

  // ---------- Render ----------
  function render(){
    // mode pill + sim controls
    $("modePill").textContent = sim.enabled ? "What if?" : "Reality";
    $("modePill").className = sim.enabled ? "pill purple" : "pill";
    $("simControls").style.display = sim.enabled ? "block" : "none";
    $("timelineModeLabel").textContent = sim.enabled ? "What if?" : "Reality";

    const st = activeState();

    // meta inputs
    $("cashOnHand").value = st.meta.cashOnHand ?? 0;
    $("bufferFloor").value = st.meta.bufferFloor ?? 0;
    $("splitPct").value = String(st.meta.splitPct ?? 0.5);

    $("payFrequency").value = st.meta.payFrequency ?? "biweekly";
    $("paycheckAmount").value = st.meta.paycheckAmount ?? 0;
    $("lastPayday").value = st.meta.lastPayday ?? "";
    $("snowballMonthly").value = st.meta.snowballMonthly ?? 0;
    $("snowballAlloc").value = st.meta.snowballAlloc ?? "per_paycheck";
    $("snowballDay").value = st.meta.snowballDay ?? 20;

    $("strategy").value = st.meta.strategy ?? "snowball";
    updateManualTargets();

    // toggle snowball day UI
    const alloc = st.meta.snowballAlloc;
    $("snowballDayWrap").style.display = alloc==="monthly_day" ? "block" : "none";
    $("allocHelp").textContent = alloc==="monthly_day" ? "Snowball posts on the chosen day." : "Snowball splits across paychecks inside the timeline.";

    // next payday
    const nxt = nextPaydayFrom(st.meta.lastPayday, st.meta.payFrequency);
    $("nextPayday").value = nxt ? fmtDateInput(nxt) : "";

    // horizon date
    const horizonEnd = horizonEndDateFromUI();

    // snapshots: Reality + What if?
    const rSnap = computeSnapshot(state, horizonEnd);
    const sSnap = computeSnapshot(sim.enabled ? sim.state : state, horizonEnd);

    $("r_safe").textContent = money(rSnap.safe);
    $("r_committed").textContent = money(rSnap.committed);
    $("r_nextpay").textContent = money(rSnap.balAtNextPay);
    $("r_horizon").textContent = money(rSnap.balHorizon);

    $("s_safe").textContent = money(sSnap.safe);
    $("s_committed").textContent = money(sSnap.committed);
    $("s_nextpay").textContent = money(sSnap.balAtNextPay);
    $("s_horizon").textContent = money(sSnap.balHorizon);

    const deltaH = sSnap.balHorizon - rSnap.balHorizon;
    $("delta_horizon").textContent = (deltaH>=0?"+":"") + money(deltaH);
    $("delta_horizon").className = "v mono " + (deltaH>=0 ? "deltaPos" : "deltaNeg");

    const rMin = state.debts.filter(d=>!d.paidOff).reduce((a,d)=>a+clamp(d.min),0);
    const sMin = (sim.enabled ? sim.state : state).debts.filter(d=>!d.paidOff).reduce((a,d)=>a+clamp(d.min),0);
    const freed = rMin - sMin;
    $("delta_minfreed").textContent = (freed>=0?"+":"") + money(freed);
    $("delta_minfreed").className = "v mono " + (freed>=0 ? "deltaPos" : "deltaNeg");

    // health pill (based on active snapshot)
    const activeSnap = sim.enabled ? sSnap : rSnap;
    const hp = $("healthPill");
    if(activeSnap.safe < 0){
      hp.textContent = "Tight (reduce snowball / adjust splits)";
      hp.className = "pill warn";
    } else if(activeSnap.balHorizon < clamp(st.meta.bufferFloor)){
      hp.textContent = "Below buffer by horizon";
      hp.className = "pill bad";
    } else {
      hp.textContent = "Healthy";
      hp.className = "pill good";
    }

    // timeline (next 10) ‚Äî from active state
    const tb = $("timelineTbody");
    tb.innerHTML = "";
    activeSnap.running.slice(0, 10).forEach(ev=>{
      const canQuickPay = (ev.amount < 0) && (ev.type !== "adj");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${ev.date.toLocaleDateString()}</td>
        <td>${escapeHtml(ev.label)}</td>
        <td class="right mono">${money(ev.amount)}</td>
        <td class="right mono">${money(ev.balance)}</td>
        <td class="right">
          <div class="row" style="justify-content:flex-end; gap:8px">
            ${canQuickPay ? `<button class="btn sm" data-act="quickPay" data-type="${ev.type}" data-ref="${ev.refId}" data-date="${fmtDateInput(ev.date)}">Quick Pay</button>` : `<span class="small">‚Äî</span>`}
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    // bills table (active state)
    const btb = $("billsTbody");
    btb.innerHTML = "";
    st.bills.forEach(b=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(b.name||"")}</td>
        <td class="right mono">${money(b.amount)}</td>
        <td class="right mono">${escapeHtml(String(b.dueDay||""))}</td>
        <td class="right">
          <input class="chk" type="checkbox" data-act="toggleSplit" data-id="${b.id}" ${b.splitAllowed?"checked":""} />
        </td>
        <td class="right">
          <div class="row" style="justify-content:flex-end; gap:8px">
            <button class="btn sm" data-act="payEarlyBill" data-id="${b.id}">Pay Early</button>
            <button class="btn ghost sm" data-act="editBill" data-id="${b.id}">Edit</button>
            <button class="btn danger sm" data-act="delBill" data-id="${b.id}">Del</button>
          </div>
        </td>
      `;
      btb.appendChild(tr);
    });

    // debts table (active state)
    const dtb = $("debtsTbody");
    dtb.innerHTML = "";
    st.debts.forEach(d=>{
      const tr = document.createElement("tr");
      const simBtns = sim.enabled && !d.paidOff ? `
        <button class="btn sm" data-act="simPayoff" data-id="${d.id}">Payoff (SIM)</button>
        <button class="btn ghost sm" data-act="simExtra" data-id="${d.id}">+ Extra (SIM)</button>
      ` : (sim.enabled ? `<span class="small">‚Äî</span>` : ``);

      tr.innerHTML = `
        <td>
          ${escapeHtml(d.name||"")}
          ${interestLine(d)}
        </td>
        <td class="right mono">${money(d.balance)}</td>
        <td class="right mono">${clamp(d.apr).toFixed(2)}%</td>
        <td class="right mono">${money(d.min)}</td>
        <td class="right mono">${escapeHtml(String(d.dueDay||""))}</td>
        <td class="right"><input class="chk" type="checkbox" data-act="togglePaidDebt" data-id="${d.id}" ${d.paidOff?"checked":""} /></td>
        <td class="right">
          ${simBtns}
          <div style="height:6px"></div>
          <button class="btn ghost sm" data-act="editDebt" data-id="${d.id}">Edit</button>
          <button class="btn danger sm" data-act="delDebt" data-id="${d.id}">Del</button>
        </td>
      `;
      dtb.appendChild(tr);
    });

    $("payoffBox").innerHTML = payoffEstimateText(st);

    // adjustments (active state)
    const atb = $("adjTbody");
    atb.innerHTML = "";
    st.adjustments
      .slice()
      .sort((a,b)=> (parseDateInput(a.date)||0) - (parseDateInput(b.date)||0))
      .forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(a.date||"")}</td>
          <td>${escapeHtml(a.note||"")}</td>
          <td class="right mono">${money(a.amount)}</td>
          <td class="right">
            <button class="btn danger sm" data-act="delAdj" data-id="${a.id}">Del</button>
          </td>
        `;
        atb.appendChild(tr);
      });

    // persist only reality state
    saveState();
  }

  // ---------- Add/Edit prompts ----------
  function addOrEditBill(existing){
    const st = activeState();
    const name = prompt("Bill name:", existing?.name ?? "");
    if(name===null) return;
    const amount = prompt("Monthly amount:", existing?.amount ?? "");
    if(amount===null) return;
    const dueDay = prompt("Due day of month (1-31):", existing?.dueDay ?? "");
    if(dueDay===null) return;
    const splitAllowed = confirm("Split Allowed? (OK = Yes, Cancel = No)");

    const bill = {
      id: existing?.id ?? uid(),
      name: name.trim(),
      amount: Number(amount)||0,
      dueDay: dueDay.trim() ? (Number(dueDay)||"") : "",
      splitAllowed: !!splitAllowed
    };

    if(existing){
      const i = st.bills.findIndex(b=>b.id===existing.id);
      if(i>=0) st.bills[i]=bill;
    } else {
      st.bills.push(bill);
    }
    render();
  }

  function addOrEditDebt(existing){
    const st = activeState();
    const name = prompt("Debt name:", existing?.name ?? "");
    if(name===null) return;
    const balance = prompt("Current balance:", existing?.balance ?? "");
    if(balance===null) return;
    const apr = prompt("APR % (0 if none):", existing?.apr ?? "");
    if(apr===null) return;
    const min = prompt("Monthly minimum payment:", existing?.min ?? "");
    if(min===null) return;
    const dueDay = prompt("Due day of month for minimum (optional):", existing?.dueDay ?? "");
    if(dueDay===null) return;

    const debt = {
      id: existing?.id ?? uid(),
      name: name.trim(),
      balance: Number(balance)||0,
      apr: Number(apr)||0,
      min: Number(min)||0,
      dueDay: dueDay.trim()? (Number(dueDay)||"") : "",
      paidOff: existing?.paidOff ?? false
    };

    if(existing){
      const i = st.debts.findIndex(d=>d.id===existing.id);
      if(i>=0) st.debts[i]=debt;
    } else {
      st.debts.push(debt);
      if(!st.meta.manualTargetId) st.meta.manualTargetId = debt.id;
    }
    render();
  }

  function addAdjustment(){
    const st = activeState();
    const date = prompt("Date (YYYY-MM-DD):", fmtDateInput(todayNoon()));
    if(date===null) return;
    const note = prompt("Note:", "");
    if(note===null) return;
    const amt = prompt("Amount (positive=in, negative=out):", "");
    if(amt===null) return;

    st.adjustments.push({
      id: uid(),
      date: date.trim(),
      note: note.trim() || "Adjustment",
      amount: Number(amt)||0
    });
    render();
  }

  // ---------- Input Wiring ----------
  $("horizonMonths").addEventListener("change", render);

  $("cashOnHand").addEventListener("input", e=>{
    const st = activeState();
    st.meta.cashOnHand = Number(e.target.value)||0;
    render();
  });
  $("bufferFloor").addEventListener("input", e=>{
    const st = activeState();
    st.meta.bufferFloor = Number(e.target.value)||0;
    render();
  });

  $("splitPct").addEventListener("change", e=>{
    const st = activeState();
    st.meta.splitPct = Number(e.target.value)||0.5;
    render();
  });

  $("payFrequency").addEventListener("change", e=>{
    const st = activeState();
    st.meta.payFrequency = e.target.value;
    render();
  });
  $("paycheckAmount").addEventListener("input", e=>{
    const st = activeState();
    st.meta.paycheckAmount = Number(e.target.value)||0;
    render();
  });
  $("lastPayday").addEventListener("change", e=>{
    const st = activeState();
    st.meta.lastPayday = e.target.value||"";
    render();
  });

  $("snowballMonthly").addEventListener("input", e=>{
    const st = activeState();
    st.meta.snowballMonthly = Number(e.target.value)||0;
    render();
  });
  $("snowballAlloc").addEventListener("change", e=>{
    const st = activeState();
    st.meta.snowballAlloc = e.target.value;
    render();
  });
  $("snowballDay").addEventListener("input", e=>{
    const st = activeState();
    st.meta.snowballDay = Number(e.target.value)||20;
    render();
  });

  $("strategy").addEventListener("change", e=>{
    const st = activeState();
    st.meta.strategy = e.target.value;
    render();
  });
  $("manualTarget").addEventListener("change", e=>{
    const st = activeState();
    st.meta.manualTargetId = e.target.value || null;
    render();
  });

  $("addBillBtn").addEventListener("click", ()=> addOrEditBill(null));
  $("addDebtBtn").addEventListener("click", ()=> addOrEditDebt(null));
  $("addAdjBtn").addEventListener("click", ()=> addAdjustment());

  // What if controls
  $("whatIfBtn").addEventListener("click", ()=>{
    if(sim.enabled){
      if(confirm("Exit What if? (sandbox changes will be discarded unless Applied).")) {
        exitWhatIf();
        render();
      }
      return;
    }
    enterWhatIf();
    render();
  });

  $("applySimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Apply What if? changes to Reality? (This will overwrite Reality with the sandbox state.)")) return;
    applyWhatIf();
    render();
  });

  $("resetSimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Reset What if? back to Reality (discard sandbox tinkering)?")) return;
    resetWhatIf();
    render();
  });

  $("exitSimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Exit What if? (discard sandbox changes unless Applied).")) return;
    exitWhatIf();
    render();
  });

  $("simOneOffBtn").addEventListener("click", ()=>{
    if(!ensureSimOn()) return;
    simAddOneOff();
    render();
  });

  $("simWorkPlanBtn").addEventListener("click", ()=>{
    if(!ensureSimOn()) return;
    simWorkPlan();
    render();
  });

  // Add Income modal wiring
  $("addIncomeBtn").addEventListener("click", ()=> openIncomeModal(todayNoon()));
  $("closeIncomeBtn").addEventListener("click", closeIncomeModal);
  $("cancelIncomeBtn").addEventListener("click", closeIncomeModal);
  $("saveIncomeBtn").addEventListener("click", addIncomeFromModal);
  $("incomeBack").addEventListener("click", (e)=>{
    if(e.target === $("incomeBack")) closeIncomeModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      if($("incomeBack").style.display === "flex") closeIncomeModal();
      if($("qrBack").style.display === "flex") closeQrModal();
    }
  });

  // Share / QR
  $("createLinkBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("Create Link uses Reality data (not What if?). Continue?")) return;
    const link = buildShareLinkFromState(state);
    $("shareLink").value = link;

    history.replaceState(null, document.title, location.pathname + location.search + "#share=" + link.split("#share=")[1]);

    if(link.length > 3500){
      alert("Heads up: this share link is pretty long. If it fails on some devices, use Export JSON instead.");
    }
  });

  $("copyLinkBtn").addEventListener("click", async ()=>{
    const v = $("shareLink").value || "";
    if(!v){
      alert("Tap Create Link first.");
      return;
    }
    try{
      await navigator.clipboard.writeText(v);
      alert("Link copied.");
    } catch {
      $("shareLink").focus();
      $("shareLink").select();
      document.execCommand("copy");
      alert("Link copied.");
    }
  });

  $("clearLinkBtn").addEventListener("click", ()=>{
    $("shareLink").value = "";
    clearShareHash();
  });

  $("createQrBtn").addEventListener("click", ()=>{
    const v = $("shareLink").value || "";
    if(!v){
      const link = buildShareLinkFromState(state);
      $("shareLink").value = link;
    }
    openQrModal($("shareLink").value);
  });

  $("closeQrBtn").addEventListener("click", closeQrModal);
  $("qrBack").addEventListener("click", (e)=>{
    if(e.target === $("qrBack")) closeQrModal();
  });

  // ---------- Delegated clicks ----------
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const act = btn.dataset.act;
    const st = activeState();

    // Quick Pay from timeline (acts on active state)
    if(act==="quickPay"){
      const type = btn.dataset.type;
      const refId = btn.dataset.ref;
      const date = parseDateInput(btn.dataset.date);
      if(!date) return;

      const horizonEnd = horizonEndDateFromUI();
      const snap = computeSnapshot(st, horizonEnd);
      const found = snap.running.find(ev => ev.type===type && ev.refId===refId && fmtDateInput(ev.date)===fmtDateInput(date));
      if(!found) return;

      const label = sim.enabled ? "Quick Pay (SIM) now?" : "Quick Pay now?";
      if(!confirm(`${label}\n\n${found.label}\n${money(found.amount)}`)) return;
      quickPay(st, found);
      render();
      return;
    }

    const id = btn.dataset.id;

    // Pay Early bill (1-click, zero prompts)
    if(act==="payEarlyBill"){
      payBillEarly(st, id);
      render();
      return;
    }

    // SIM actions
    if(act==="simPayoff"){ simPayoffDebt(id); render(); return; }
    if(act==="simExtra"){ simExtraToDebt(id); render(); return; }

    // bills/debts/adjustments edits
    if(act==="delBill"){ st.bills = st.bills.filter(b=>b.id!==id); render(); return; }
    if(act==="editBill"){ const b = st.bills.find(x=>x.id===id); if(b) addOrEditBill(b); return; }

    if(act==="delDebt"){
      st.debts = st.debts.filter(d=>d.id!==id);
      if(st.meta.manualTargetId===id) st.meta.manualTargetId=null;
      render(); return;
    }
    if(act==="editDebt"){ const d = st.debts.find(x=>x.id===id); if(d) addOrEditDebt(d); return; }

    if(act==="delAdj"){ st.adjustments = st.adjustments.filter(a=>a.id!==id); render(); return; }
  });

  document.addEventListener("change", (e)=>{
    const t = e.target;
    const st = activeState();

    // toggle split on bills
    if(t && t.matches('input[type="checkbox"][data-act="toggleSplit"]')){
      const id = t.dataset.id;
      const b = st.bills.find(x=>x.id===id);
      if(b) b.splitAllowed = !!t.checked;
      render();
    }

    // toggle paid off debt
    if(t && t.matches('input[type="checkbox"][data-act="togglePaidDebt"]')){
      const id = t.dataset.id;
      const d = st.debts.find(x=>x.id===id);
      if(d) d.paidOff = !!t.checked;
      render();
    }
  });

  // Export / Import / Reset (Reality only)
  $("exportBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("You are in What if?. Export will export Reality only. Continue?")) return;
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "autopilot-tracker-v3_2-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  $("importBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("Import replaces Reality. Exit What if? first (recommended). Continue anyway?")) return;
    $("fileInput").click();
  });

  $("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const p = JSON.parse(text);
      state = normalizeState(p);
      saveState();
      if(sim.enabled){
        sim.state = deepClone(state);
      }
      render();
      alert("Import complete.");
    } catch {
      alert("Import failed. Use an exported JSON backup.");
    } finally {
      e.target.value = "";
    }
  });

  $("resetBtn").addEventListener("click", ()=>{
    if(!confirm("Reset all tracker data on this device? This cannot be undone.")) return;
    localStorage.removeItem(KEY);
    state = deepClone(defaultState);
    exitWhatIf();
    render();
  });

  // ---------- Incoming share handling ----------
  function showIncomingShareBanner(){
    $("incomingShareBanner").style.display = "block";
  }
  function hideIncomingShareBanner(){
    $("incomingShareBanner").style.display = "none";
  }

  $("importShareBtn").addEventListener("click", ()=>{
    const enc = getShareFromHash();
    if(!enc){
      hideIncomingShareBanner();
      return;
    }
    try{
      const json = base64UrlDecode(enc);
      const p = JSON.parse(json);
      state = normalizeState(p);
      saveState();
      exitWhatIf();
      render();
      hideIncomingShareBanner();
      clearShareHash();
      alert("Import complete.");
    } catch {
      alert("Import failed (bad/too-long link). Use Export JSON instead.");
      hideIncomingShareBanner();
    }
  });

  $("ignoreShareBtn").addEventListener("click", ()=>{
    hideIncomingShareBanner();
    clearShareHash();
  });

  // Init
  (function init(){
    const enc = getShareFromHash();
    if(enc){
      showIncomingShareBanner();
      $("shareLink").value = location.href;
    }
    render();
  })();
</script>
</body>
</html>      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid rgba(34,48,77,.85); background:#0c1324; color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(124,92,255,.95); box-shadow:0 0 0 3px rgba(124,92,255,.2)}
    .btn{
      border:1px solid rgba(124,92,255,.9);
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      color:white; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:900;
    }
    .btn.sm{padding:7px 10px; font-size:12px; border-radius:10px}
    .btn.ghost{background: transparent; border-color: rgba(34,48,77,.95); color: var(--text)}
    .btn.danger{background: linear-gradient(180deg, rgba(255,77,109,.95), rgba(255,77,109,.75)); border-color: rgba(255,77,109,.9)}
    .btn.good{background: linear-gradient(180deg, rgba(51,209,122,.95), rgba(51,209,122,.75)); border-color: rgba(51,209,122,.9)}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(34,48,77,.9);
      color:var(--muted);
    }
    .pill.good{color:#b9ffe0; border-color: rgba(51,209,122,.6); background: rgba(51,209,122,.08)}
    .pill.warn{color:#ffe0a3; border-color: rgba(255,176,32,.6); background: rgba(255,176,32,.08)}
    .pill.bad{color:#ffd0d7; border-color: rgba(255,77,109,.6); background: rgba(255,77,109,.08)}
    .pill.purple{color:#e5dcff; border-color: rgba(124,92,255,.75); background: rgba(124,92,255,.10)}
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1}
    .small{font-size:12px; color:var(--muted)}
    .title{font-weight:900; letter-spacing:.2px}
    .hr{height:1px; background:rgba(34,48,77,.6); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(34,48,77,.55); vertical-align:middle}
    th{color:var(--muted); text-align:left; font-weight:650; font-size:12px}
    .right{text-align:right}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background: linear-gradient(to top, rgba(11,15,25,.95), rgba(11,15,25,.65));
      border-top:1px solid rgba(34,48,77,.55);
      padding:10px 12px;
    }
    .footerbar .wrap{max-width:1200px; margin:0 auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px; color: #d9ddff; background: rgba(124,92,255,.12);
      border: 1px solid rgba(124,92,255,.35); padding: 2px 6px; border-radius: 8px;
    }
    .twoCol{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:620px){ .twoCol{grid-template-columns:1fr 1fr} }
    .chk{transform: scale(1.1);}
    .mini{
      display:block; margin-top:4px; font-size:11px; color:var(--muted); line-height:1.35;
    }
    .badgeSim{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:14px;
      border:1px solid rgba(124,92,255,.7);
      background: rgba(124,92,255,.10);
      color:#efeaff;
      font-weight:900; font-size:12px;
    }
    .deltaPos{color:#b9ffe0}
    .deltaNeg{color:#ffd0d7}
    .snapGrid{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    @media(min-width:760px){ .snapGrid{grid-template-columns:1fr 1fr} }
    .snapBox{
      border:1px solid rgba(34,48,77,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(12,19,36,.45);
    }
    .snapHdr{display:flex; align-items:center; gap:8px}
    .snapHdr b{font-size:13px}
    .snapRow{display:flex; justify-content:space-between; gap:10px; margin-top:8px}
    .snapRow .k{color:var(--muted); font-size:12px}
    .snapRow .v{font-weight:900}
    .simBanner{
      margin-top:10px;
      border:1px solid rgba(124,92,255,.65);
      border-radius:14px;
      padding:10px;
      background: rgba(124,92,255,.10);
    }

    /* Share banner + modal */
    .shareBanner{
      position:sticky;
      top:0;
      z-index:25;
      margin:10px 16px 0;
      border:1px solid rgba(255,176,32,.55);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,176,32,.08);
      backdrop-filter: blur(10px);
    }
    .shareBanner b{color:#ffe0a3}
    .modalBack{
      position:fixed; inset:0; z-index:60;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(18,26,42,.96), rgba(18,26,42,.86));
      border:1px solid rgba(34,48,77,.8);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .qrBox{
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(34,48,77,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(12,19,36,.45);
      overflow:auto;
    }
    .btnline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  </style>
</head>
<body>

<!-- Incoming share banner (only shown when a #share=... link is opened) -->
<div id="incomingShareBanner" class="shareBanner" style="display:none">
  <div class="row">
    <div style="flex:1; min-width:220px">
      <div class="title">Incoming Share Detected</div>
      <div class="small">
        This link contains a saved tracker snapshot. Importing will overwrite <b>THIS device‚Äôs</b> local data.
      </div>
    </div>
    <div class="btnline">
      <button class="btn good sm" id="importShareBtn">Import</button>
      <button class="btn ghost sm" id="ignoreShareBtn">Ignore</button>
    </div>
  </div>
</div>

<header>
  <h1>
    Autopilot Bills + Snowball Tracker <span class="pill">V3.2</span>
    <span id="modePill" class="pill">Reality</span>
    <span class="spacer"></span>
    <button class="btn ghost sm" id="whatIfBtn">What if?</button>
  </h1>
  <div class="sub">Reality stays true. <b>What if?</b> lets you tinker safely side-by-side ‚Äî then Apply if you choose.</div>
</header>

<main class="grid cols2">
  <!-- LEFT -->
  <section class="grid">
    <!-- CURRENT SNAPSHOT -->
    <div class="card">
      <div class="row">
        <div>
          <div class="title">Current Snapshot</div>
          <div class="small">Timeline-based from <b>today</b>. Quick Pay marks items paid for this month and logs it automatically.</div>
        </div>
        <div class="spacer"></div>
        <span id="healthPill" class="pill">Ready</span>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Cash On Hand (right now)</label>
          <input id="cashOnHand" type="number" step="0.01" min="0" placeholder="e.g., 3000.00" />
        </div>
        <div>
          <label>Buffer Floor (don‚Äôt drop below)</label>
          <input id="bufferFloor" type="number" step="0.01" min="0" placeholder="e.g., 1500.00" />
        </div>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Split % used for ‚ÄúSplit Allowed‚Äù bills (planning only)</label>
          <select id="splitPct">
            <option value="1.0">100% (no split)</option>
            <option value="0.9">90%</option>
            <option value="0.8">80%</option>
            <option value="0.7">70%</option>
            <option value="0.6">60%</option>
            <option value="0.5">50% (default)</option>
          </select>
          <div class="small">Affects <b>Committed before next payday</b> + <b>Safe-to-spend</b>, not your actual bill amount.</div>
        </div>
        <div>
          <label>Futurecasting Horizon</label>
          <select id="horizonMonths">
            <option value="1">+1 month</option>
            <option value="2">+2 months</option>
            <option value="3" selected>+3 months</option>
            <option value="4">+4 months</option>
            <option value="6">+6 months</option>
          </select>
          <div class="small">Horizon affects projections in both Reality + What if?</div>
        </div>
      </div>

      <div id="simControls" class="simBanner" style="display:none">
        <div class="row">
          <div class="badgeSim">üü£ What if? mode is ON</div>
          <div class="spacer"></div>
          <button class="btn good sm" id="applySimBtn">Apply to Reality</button>
          <button class="btn ghost sm" id="resetSimBtn">Reset What if?</button>
          <button class="btn danger sm" id="exitSimBtn">Exit What if?</button>
        </div>
        <div class="small" style="margin-top:8px; line-height:1.5">
          Changes here are sandboxed. Reality stays put until you hit <b>Apply to Reality</b>.
        </div>
      </div>

      <!-- Side-by-side snapshot -->
      <div class="snapGrid" style="margin-top:12px">
        <div class="snapBox">
          <div class="snapHdr">
            <b>Reality</b> <span class="pill" style="padding:4px 8px">Anchored</span>
          </div>
          <div class="snapRow"><span class="k">Safe-to-Spend NOW</span><span id="r_safe" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Committed ‚Üí Next Payday</span><span id="r_committed" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Next Payday</span><span id="r_nextpay" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Horizon End</span><span id="r_horizon" class="v mono">$0.00</span></div>
        </div>

        <div class="snapBox">
          <div class="snapHdr">
            <b>What if?</b> <span class="pill purple" style="padding:4px 8px">Sandbox</span>
          </div>
          <div class="snapRow"><span class="k">Safe-to-Spend NOW</span><span id="s_safe" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Committed ‚Üí Next Payday</span><span id="s_committed" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Next Payday</span><span id="s_nextpay" class="v mono">$0.00</span></div>
          <div class="snapRow"><span class="k">Proj. @ Horizon End</span><span id="s_horizon" class="v mono">$0.00</span></div>

          <div class="hr"></div>
          <div class="snapRow">
            <span class="k">Delta vs Reality (Horizon)</span>
            <span id="delta_horizon" class="v mono">$0.00</span>
          </div>
          <div class="snapRow">
            <span class="k">Min Payments Freed / mo</span>
            <span id="delta_minfreed" class="v mono">$0.00</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div style="flex:1">
          <div class="small">
            <span class="kbd">Autopilot</span> Next 10 events (running balance) ‚Äî shows <span id="timelineModeLabel">Reality</span>
            <span class="small"> ¬∑ </span>
            <span class="small">Use <span class="kbd">+ Income</span> to drop a quick one-time deposit on that row‚Äôs date.</span>
          </div>
          <div style="margin-top:10px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th class="right">Amount</th>
                  <th class="right">Balance</th>
                  <th class="right">Action</th>
                </tr>
              </thead>
              <tbody id="timelineTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- INCOME + SNOWBALL SETTINGS -->
    <div class="card">
      <div class="row">
        <div class="title">Income + Snowball Settings (one-time)</div>
        <div class="spacer"></div>
        <span class="pill good">Unified</span>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Pay Frequency</label>
          <select id="payFrequency">
            <option value="biweekly">Biweekly (every 14 days)</option>
            <option value="weekly">Weekly (every 7 days)</option>
            <option value="semimonthly">Semi-monthly (15th & last day)</option>
          </select>
        </div>
        <div>
          <label>Paycheck Amount (net)</label>
          <input id="paycheckAmount" type="number" step="0.01" min="0" placeholder="e.g., 1840.80" />
        </div>
        <div>
          <label>Last Payday (date)</label>
          <input id="lastPayday" type="date" />
        </div>
        <div>
          <label>Next Payday (auto)</label>
          <input id="nextPayday" type="date" disabled />
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCol">
        <div>
          <label>Snowball (monthly total)</label>
          <input id="snowballMonthly" type="number" step="0.01" min="0" placeholder="e.g., 600.00" />
          <div class="small">Autopilot allocates it across paychecks or a single day.</div>
        </div>
        <div>
          <label>Snowball Allocation</label>
          <select id="snowballAlloc">
            <option value="per_paycheck">Per Paycheck (split across paychecks)</option>
            <option value="monthly_day">Monthly on Day‚Ä¶</option>
          </select>
          <div class="small" id="allocHelp">Default: split across paychecks.</div>
        </div>
        <div id="snowballDayWrap" style="display:none">
          <label>Snowball Day of Month</label>
          <input id="snowballDay" type="number" min="1" max="31" step="1" placeholder="e.g., 20" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCol">
        <div>
          <label>Quick Income Amount (for 1-click + Income)</label>
          <input id="quickIncome" type="number" step="0.01" min="0" placeholder="e.g., 100.00" />
          <div class="small">Used by the <span class="kbd">+ Income</span> buttons (timeline + bills).</div>
        </div>
        <div>
          <label>Quick Presets</label>
          <div class="row" style="gap:8px; margin-top:2px">
            <button class="btn ghost sm" data-act="setQuickIncome" data-v="50">+$50</button>
            <button class="btn ghost sm" data-act="setQuickIncome" data-v="100">+$100</button>
            <button class="btn ghost sm" data-act="setQuickIncome" data-v="200">+$200</button>
            <button class="btn ghost sm" data-act="setQuickIncome" data-v="500">+$500</button>
            <button class="btn ghost sm" data-act="setQuickIncome" data-v="1000">+$1,000</button>
          </div>
          <div class="small" style="margin-top:8px">Tap preset ‚Üí then 1-click <span class="kbd">+ Income</span> anywhere.</div>
        </div>
      </div>
    </div>

    <!-- BILLS -->
    <div class="card">
      <div class="row">
        <div class="title">Bills (monthly)</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="addBillBtn">+ Add Bill</button>
      </div>
      <div class="small">Mark ‚ÄúSplit Allowed‚Äù if your provider lets you split/extend without disaster.</div>
      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Bill</th>
              <th class="right">Amount</th>
              <th class="right">Due Day</th>
              <th class="right">Split?</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="billsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DEBTS -->
    <div class="card">
      <div class="row">
        <div class="title">Debts (minimums + snowball target)</div>
        <div class="spacer"></div>
        <button class="btn" id="addDebtBtn">+ Add Debt</button>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div>
          <label>Target Strategy</label>
          <select id="strategy">
            <option value="snowball">Snowball (smallest balance)</option>
            <option value="avalanche">Avalanche (highest APR)</option>
            <option value="manual">Manual (choose)</option>
          </select>
        </div>
        <div>
          <label>Manual Target (if Manual)</label>
          <select id="manualTarget"></select>
        </div>
      </div>

      <div class="small" style="margin-top:8px">Debt min due day optional. If blank, assumes end-of-month.</div>

      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Debt</th>
              <th class="right">Balance</th>
              <th class="right">APR</th>
              <th class="right">Min</th>
              <th class="right">Due</th>
              <th class="right">Paid Off</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="debtsTbody"></tbody>
        </table>
      </div>

      <div id="payoffBox" class="small" style="margin-top:12px"></div>
    </div>

    <!-- QUICK ADJUSTMENTS -->
    <div class="card">
      <div class="row">
        <div class="title">Adjustments (one-offs)</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="addAdjBtn">+ Add Adjustment</button>
      </div>
      <div class="small">Reality log: surprise bill, extra payment, refund, paid early, etc.</div>

      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Note</th>
              <th class="right">Amount</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="adjTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="grid">
    <div class="card">
      <div class="title">Autopilot Rules (simple)</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        ‚Ä¢ You input bills/debts/income once.<br>
        ‚Ä¢ Daily, update only <b>Cash On Hand</b> (optional) and use <b>Quick Pay</b> when you pay something.<br>
        ‚Ä¢ Split Allowed bills reduce ‚ÄúCommitted before next payday‚Äù using the Split %.
      </div>
    </div>

    <div class="card">
      <div class="title">What if? Playground (fast)</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        In <b>What if?</b> mode, use the <b>SIM</b> buttons in Debts to test:<br>
        ‚Ä¢ payoff one debt<br>
        ‚Ä¢ throw extra at a balance<br>
        ‚Ä¢ see min payments freed + horizon delta<br><br>
        Then hit <b>Apply to Reality</b> if you want to commit.
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn ghost sm" id="simOneOffBtn">+ One-time (SIM)</button>
        <button class="btn ghost sm" id="simWorkPlanBtn">Work Plan (SIM)</button>
      </div>
      <div class="small" style="margin-top:10px">These only change the sandbox while What if? is ON.</div>
    </div>

    <div class="card">
      <div class="title">Quick Actions</div>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <button class="btn ghost" id="importBtn">Import JSON</button>
        <button class="btn ghost" id="createLinkBtn">Create Link</button>
        <button class="btn ghost" id="copyLinkBtn">Copy Link</button>
        <button class="btn ghost" id="createQrBtn">Create QR</button>
        <button class="btn ghost" id="clearLinkBtn">Clear</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div class="twoCol" style="margin-top:10px">
        <div style="grid-column:1/-1">
          <label>Share Link (local snapshot)</label>
          <input id="shareLink" class="mono" readonly placeholder="Tap Create Link‚Ä¶" />
          <div class="small" style="margin-top:6px">
            Share Link / QR encodes your current Reality data into the URL hash. It does <b>not</b> upload anything.
          </div>
        </div>
      </div>

      <input id="fileInput" type="file" accept="application/json" style="display:none" />
      <div class="small" style="margin-top:10px">Export/Import moves your data between devices. It does <b>not</b> publish anything.</div>
    </div>

    <div class="card">
      <div class="title">NFC Use</div>
      <div class="small" style="margin-top:8px; line-height:1.5">
        Write your GitHub Pages URL onto an NFC tag.
        <br><span class="kbd">Privacy</span> Everything saves on-device (localStorage). No bank logins.
      </div>
    </div>
  </aside>
</main>

<div class="footerbar">
  <div class="wrap">
    <span class="pill good">Split Bills</span>
    <span class="pill">Quick Pay</span>
    <span class="pill purple">What if?</span>
    <span class="pill warn">Local-only</span>
    <div class="spacer"></div>
    <span class="small">V3.2 ‚Äî Reality + What if? (side-by-side)</span>
  </div>
</div>

<!-- QR Modal -->
<div id="qrBack" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row">
      <div class="title">Share QR</div>
      <div class="spacer"></div>
      <button class="btn ghost sm" id="closeQrBtn">Close</button>
    </div>
    <div class="small" style="margin-top:8px; line-height:1.5">
      Scan this on your SmartBoard/device to open the tracker with an <b>optional</b> Import prompt.
    </div>
    <div class="qrBox" style="margin-top:10px">
      <canvas id="qrCanvas" width="320" height="320" style="max-width:100%; height:auto"></canvas>
    </div>
    <div class="small" style="margin-top:10px">
      Tip: if your snapshot is huge, the share link may get too long. In that case, use <b>Export JSON</b> instead.
    </div>
  </div>
</div>

<script>
  // ---------- Utils ----------
  const $ = (id) => document.getElementById(id);
  const money = (n) => (Number(n||0)).toLocaleString(undefined, {style:"currency", currency:"USD"});
  const clamp = (v) => Number.isFinite(v) ? v : 0;

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // Dates (local noon avoids DST weirdness)
  function todayNoon(){
    const d = new Date();
    d.setHours(12,0,0,0);
    return d;
  }
  function parseDateInput(v){
    if(!v) return null;
    const [y,m,d] = v.split("-").map(Number);
    if(!y||!m||!d) return null;
    return new Date(y, m-1, d, 12,0,0,0);
  }
  function fmtDateInput(d){
    if(!(d instanceof Date)) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDays(d, days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate()+days);
    return x;
  }
  function endOfMonth(d){
    return new Date(d.getFullYear(), d.getMonth()+1, 0, 12,0,0,0);
  }
  function addMonthsKeepDay(d, months){
    const x = new Date(d.getTime());
    const day = x.getDate();
    x.setMonth(x.getMonth()+months);
    if(x.getDate() !== day){
      x.setDate(0);
      x.setHours(12,0,0,0);
    }
    x.setHours(12,0,0,0);
    return x;
  }

  // ---------- Storage ----------
  // ‚úÖ SAME KEY (backwards compatible)
  const KEY = "autopilot_snowball_v3_2";

  const defaultState = {
    meta:{
      cashOnHand:0,
      bufferFloor:0,
      splitPct:0.5,
      payFrequency:"biweekly",
      paycheckAmount:0,
      lastPayday:"",
      snowballMonthly:0,
      snowballAlloc:"per_paycheck",
      snowballDay:20,
      strategy:"snowball",
      manualTargetId:null,
      // NEW (safe default): quick income for 1-click +Income buttons
      quickIncome: 100
    },
    bills:[], // {id,name,amount,dueDay,splitAllowed}
    debts:[], // {id,name,balance,apr,min,dueDay,paidOff}
    adjustments:[], // {id,date,note,amount}
    paidCycles:{} // map cycleKey -> true (prevents double-counting after Quick Pay)
  };

  let state = loadState();

  const sim = {
    enabled:false,
    state:null, // deep clone of state
  };

  function deepClone(obj){
    try{ return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj)); }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return deepClone(defaultState);
      const p = JSON.parse(raw);
      return normalizeState(p);
    } catch {
      return deepClone(defaultState);
    }
  }

  function normalizeState(p){
    const merged = {
      meta:{...defaultState.meta, ...(p.meta||{})},
      bills:Array.isArray(p.bills)?p.bills:[],
      debts:Array.isArray(p.debts)?p.debts:[],
      adjustments:Array.isArray(p.adjustments)?p.adjustments:[],
      paidCycles: (p.paidCycles && typeof p.paidCycles==="object") ? p.paidCycles : {}
    };
    // ensure number
    merged.meta.quickIncome = Number(merged.meta.quickIncome);
    if(!Number.isFinite(merged.meta.quickIncome) || merged.meta.quickIncome < 0) merged.meta.quickIncome = defaultState.meta.quickIncome;
    return merged;
  }

  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function activeState(){ return sim.enabled ? sim.state : state; }

  // ---------- Paycheck schedule ----------
  function nextPaydayFrom(lastPaydayStr, freq){
    const last = parseDateInput(lastPaydayStr);
    if(!last) return null;
    const now = todayNoon();

    if(freq==="weekly"){
      let nxt = addDays(last, 7);
      while(nxt < now) nxt = addDays(nxt, 7);
      return nxt;
    }
    if(freq==="biweekly"){
      let nxt = addDays(last, 14);
      while(nxt < now) nxt = addDays(nxt, 14);
      return nxt;
    }
    // semi-monthly: 15th & last day
    const y = now.getFullYear(), m = now.getMonth();
    const fifteenth = new Date(y, m, 15, 12,0,0,0);
    const monthEnd = endOfMonth(now);
    if(now < fifteenth) return fifteenth;
    if(now < monthEnd) return monthEnd;
    const nm = new Date(y, m+1, 1, 12,0,0,0);
    return new Date(nm.getFullYear(), nm.getMonth(), 15, 12,0,0,0);
  }

  function generatePaychecks(st, startDate, endDate){
    const freq = st.meta.payFrequency;
    const amt = clamp(st.meta.paycheckAmount);
    const last = parseDateInput(st.meta.lastPayday);
    if(!last || amt<=0) return [];

    let next = nextPaydayFrom(st.meta.lastPayday, freq);
    if(!next) return [];

    const checks = [];
    if(freq==="semimonthly"){
      let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1, 12,0,0,0);
      while(cursor <= endDate){
        const fif = new Date(cursor.getFullYear(), cursor.getMonth(), 15, 12,0,0,0);
        const eom = endOfMonth(cursor);
        [fif, eom].forEach(d=>{
          if(d >= startDate && d <= endDate && d >= next) checks.push({date:d, amount:amt, label:"Paycheck"});
        });
        cursor = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1, 12,0,0,0);
      }
      return checks.sort((a,b)=>a.date-b.date);
    }

    let d = new Date(next.getTime());
    while(d <= endDate){
      if(d >= startDate) checks.push({date:new Date(d.getTime()), amount:amt, label:"Paycheck"});
      d = addDays(d, freq==="weekly" ? 7 : 14);
    }
    return checks;
  }

  // ---------- Targets ----------
  function chooseTargetId(st){
    const active = st.debts.filter(d=>!d.paidOff);
    if(active.length===0) return null;

    const strat = st.meta.strategy;
    if(strat==="manual" && st.meta.manualTargetId){
      const found = active.find(d=>d.id===st.meta.manualTargetId);
      if(found) return found.id;
    }
    if(strat==="avalanche"){
      active.sort((a,b)=> clamp(b.apr)-clamp(a.apr) || clamp(a.balance)-clamp(b.balance));
      return active[0].id;
    }
    active.sort((a,b)=> clamp(a.balance)-clamp(b.balance) || clamp(b.apr)-clamp(a.apr));
    return active[0].id;
  }

  function updateManualTargets(){
    const st = activeState();
    const sel = $("manualTarget");
    sel.innerHTML = "";
    const debts = st.debts.filter(d=>!d.paidOff);
    const opt = document.createElement("option");
    opt.value="";
    opt.textContent = debts.length ? "Select target‚Ä¶" : "No active debts";
    sel.appendChild(opt);

    debts.forEach(d=>{
      const o = document.createElement("option");
      o.value=d.id;
      o.textContent = `${d.name} (${money(d.balance)})`;
      sel.appendChild(o);
    });
    sel.value = st.meta.manualTargetId || "";
  }

  // ---------- Paid-cycle keys ----------
  function cycleKey(type, refId, date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${type}:${refId}:${y}-${m}`;
  }
  function isPaid(st, type, refId, date){
    return !!st.paidCycles[cycleKey(type, refId, date)];
  }
  function markPaid(st, type, refId, date){
    st.paidCycles[cycleKey(type, refId, date)] = true;
  }

  // ---------- Timeline event generation ----------
  function billEventDateForMonth(year, monthIndex, dueDay){
    const d = new Date(year, monthIndex, dueDay, 12,0,0,0);
    if(d.getMonth() !== monthIndex) return null;
    return d;
  }

  function generateMonthlyEvents(st, startDate, endDate){
    const events = [];
    let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1, 12,0,0,0);

    while(cursor <= endDate){
      const y = cursor.getFullYear(), m = cursor.getMonth();

      // bills
      st.bills.forEach(b=>{
        const dueDay = Number(b.dueDay);
        if(!dueDay) return;
        const date = billEventDateForMonth(y,m,dueDay);
        if(!date) return;
        if(date >= startDate && date <= endDate){
          if(isPaid(st, "bill", b.id, date)) return;
          events.push({
            date, type:"bill", refId:b.id,
            label:`Bill: ${b.name}${b.splitAllowed ? " (Split Allowed)" : ""}`,
            amount:-clamp(b.amount),
            splitAllowed: !!b.splitAllowed
          });
        }
      });

      // debt minimums
      st.debts.filter(d=>!d.paidOff).forEach(d=>{
        const dueDay = Number(d.dueDay);
        const date = dueDay ? billEventDateForMonth(y,m,dueDay) : endOfMonth(new Date(y,m,1,12,0,0,0));
        if(!date) return;
        if(date >= startDate && date <= endDate){
          if(isPaid(st, "min", d.id, date)) return;
          events.push({
            date, type:"min", refId:d.id,
            label:`Min: ${d.name}`,
            amount:-clamp(d.min)
          });
        }
      });

      cursor = new Date(y, m+1, 1, 12,0,0,0);
    }

    // adjustments (one-offs)
    st.adjustments.forEach(a=>{
      const date = parseDateInput(a.date);
      if(!date) return;
      if(date >= startDate && date <= endDate){
        events.push({date, type:"adj", refId:a.id, label:`Adj: ${a.note}`, amount:clamp(a.amount)});
      }
    });

    return events;
  }

  function generateSnowballEvents(st, startDate, endDate, paychecks){
    const events = [];
    const monthly = clamp(st.meta.snowballMonthly);
    if(monthly <= 0) return events;

    const alloc = st.meta.snowballAlloc;

    if(alloc === "monthly_day"){
      const day = Math.max(1, Math.min(31, Number(st.meta.snowballDay)||20));
      const now = todayNoon();
      const date = billEventDateForMonth(now.getFullYear(), now.getMonth(), day);
      if(date && date >= startDate && date <= endDate){
        if(!isPaid(st, "snowball", "monthly", date)){
          const targetId = chooseTargetId(st);
          const targetName = targetId ? (st.debts.find(d=>d.id===targetId)?.name || "Target") : "Target";
          events.push({date, type:"snowball", refId:"monthly", label:`Snowball ‚Üí ${targetName}`, amount:-monthly});
        }
      }
      return events;
    }

    // per paycheck split
    const checksInRange = paychecks.filter(p=>p.date >= startDate && p.date <= endDate);
    if(checksInRange.length === 0) return events;

    const per = monthly / checksInRange.length;
    const targetId = chooseTargetId(st);
    const targetName = targetId ? (st.debts.find(d=>d.id===targetId)?.name || "Target") : "Target";

    checksInRange.forEach(p=>{
      const ref = "percheck:"+fmtDateInput(p.date);
      if(isPaid(st, "snowball", ref, p.date)) return;
      events.push({date: p.date, type:"snowball", refId:ref, label:`Snowball ‚Üí ${targetName}`, amount:-per});
    });

    return events;
  }

  function buildTimeline(st, horizonEndDate){
    const start = todayNoon();
    const end = horizonEndDate;

    const paychecks = generatePaychecks(st, start, end);
    const paycheckEvents = paychecks.map(p=>({date:p.date, type:"income", refId:"income:"+fmtDateInput(p.date), label:p.label, amount:clamp(p.amount)}));

    const monthlyEvents = generateMonthlyEvents(st, start, end);
    const snowballEvents = generateSnowballEvents(st, start, end, paychecks);

    const all = [...paycheckEvents, ...monthlyEvents, ...snowballEvents]
      .sort((a,b)=> a.date - b.date || a.type.localeCompare(b.type));

    return {start, end, paychecks, events: all};
  }

  // ---------- Snapshot calculations ----------
  function computeSnapshot(st, horizonEndDate){
    const {events} = buildTimeline(st, horizonEndDate);
    const cash = clamp(st.meta.cashOnHand);
    const buffer = clamp(st.meta.bufferFloor);
    const splitPct = clamp(st.meta.splitPct);

    const nextPay = nextPaydayFrom(st.meta.lastPayday, st.meta.payFrequency);

    // committed before next payday (planning) ‚Äî uses Split % for splitAllowed bills
    let committed = 0;
    if(nextPay){
      events.forEach(ev=>{
        if(ev.date <= nextPay && ev.amount < 0){
          let add = -ev.amount;
          if(ev.type==="bill" && ev.splitAllowed) add = add * splitPct;
          committed += add;
        }
      });
    }

    const safe = cash - buffer - committed;

    // Running balance
    let bal = cash;
    const running = events.map(ev=>{
      bal += ev.amount;
      return {...ev, balance: bal};
    });

    // Balance up to next payday date
    let balAtNextPay = cash;
    if(nextPay){
      events.forEach(ev=>{
        if(ev.date <= nextPay) balAtNextPay += ev.amount;
      });
    }

    // Horizon end
    let balHorizon = cash;
    events.forEach(ev=>{ balHorizon += ev.amount; });

    return { nextPay, committed, safe, running, balAtNextPay, balHorizon };
  }

  function horizonEndDateFromUI(){
    const m = Number($("horizonMonths").value||3);
    const d = todayNoon();
    const endMonth = endOfMonth(addMonthsKeepDay(d, m-1));
    return endMonth;
  }

  // ---------- Payoff estimate (simple) ----------
  function payoffEstimateText(st){
    const active = st.debts.filter(d=>!d.paidOff);
    const monthlyExtra = clamp(st.meta.snowballMonthly);
    if(active.length===0) return "All debts marked paid off. üéâ";
    const mins = active.reduce((a,d)=> a + clamp(d.min), 0);
    const total = active.reduce((a,d)=> a + clamp(d.balance), 0);
    const pay = mins + monthlyExtra;
    if(pay <= 0) return "Add minimum payments (and optional snowball) to estimate payoff.";
    const roughMonths = Math.ceil(total / Math.max(1, pay)); // rough, ignores interest
    const years = Math.floor(roughMonths/12), rem = roughMonths%12;
    const pretty = years>0 ? `${years}y ${rem}m` : `${rem}m`;
    return `Rough payoff pace (ignores interest): <b>${pretty}</b> at ~${money(pay)}/month toward debt.`;
  }

  // ---------- Interest helper line ----------
  function interestLine(d){
    const bal = clamp(d.balance);
    const apr = clamp(d.apr);
    const min = clamp(d.min);
    if(bal<=0 || apr<=0) return `<span class="mini">Est. interest this month: ${money(0)} ¬∑ Min to principal: ${money(min)}</span>`;
    const interest = bal * (apr/100) / 12;
    const principal = Math.max(0, min - interest);
    const warn = principal <= 0 ? ` ¬∑ <span style="color:#ffe0a3">‚ö† min barely touches principal</span>` : "";
    return `<span class="mini">Est. interest this month: ${money(interest)} ¬∑ Min to principal: ${money(principal)}${warn}</span>`;
  }

  // ---------- Quick Pay / Pay Early / +Income (1-click, zero prompts) ----------
  function quickPay(st, ev){
    const today = todayNoon();
    const dateStr = fmtDateInput(today);

    st.adjustments.push({
      id: uid(),
      date: dateStr,
      note: `Quick Paid ‚Äî ${ev.label}${sim.enabled ? " (SIM)" : ""}`,
      amount: ev.amount
    });

    markPaid(st, ev.type, ev.refId, ev.date);
  }

  function payBillEarly(st, billId){
    const b = st.bills.find(x=>x.id===billId);
    if(!b) return;
    const today = todayNoon();

    // one-click: apply payment now, mark this bill paid for this month
    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(today),
      note: `Paid Early ‚Äî Bill: ${b.name}${sim.enabled ? " (SIM)" : ""}`,
      amount: -clamp(b.amount)
    });

    // mark as paid for this month using the bill's actual due-date month key
    const dueDay = Number(b.dueDay) || today.getDate();
    const dueDate = billEventDateForMonth(today.getFullYear(), today.getMonth(), dueDay) || today;
    markPaid(st, "bill", b.id, dueDate);
  }

  function addQuickIncomeOnDate(st, dateObj, sourceLabel){
    const amt = clamp(st.meta.quickIncome);
    if(amt <= 0) return;
    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(dateObj),
      note: `+ Income ‚Äî ${money(amt)} (${sourceLabel})${sim.enabled ? " (SIM)" : ""}`,
      amount: amt
    });
  }

  // ---------- What if? Simulation helpers ----------
  function enterWhatIf(){
    if(sim.enabled) return;
    sim.enabled = true;
    sim.state = deepClone(state);
  }
  function exitWhatIf(){
    sim.enabled = false;
    sim.state = null;
  }
  function resetWhatIf(){
    if(!sim.enabled) return;
    sim.state = deepClone(state);
  }
  function applyWhatIf(){
    if(!sim.enabled) return;
    state = deepClone(sim.state);
    saveState();
    exitWhatIf();
  }
  function ensureSimOn(){
    if(!sim.enabled){
      alert("Turn on What if? first (top-right).");
      return false;
    }
    return true;
  }

  function simAddOneOff(){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const date = prompt("SIM one-time date (YYYY-MM-DD):", fmtDateInput(todayNoon()));
    if(date===null) return;
    const note = prompt("SIM note:", "What if? one-time");
    if(note===null) return;
    const amt = prompt("SIM amount (positive=in, negative=out):", "");
    if(amt===null) return;

    st.adjustments.push({
      id: uid(),
      date: date.trim(),
      note: (note.trim() || "What if? one-time") + " (SIM)",
      amount: Number(amt)||0
    });
  }

  function simWorkPlan(){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const pick = prompt(
`Work Plan (SIM) ‚Äî enter 80 / 100 / 120, or type a paycheck amount:
- 80 hrs example: 1391.31
- 100 hrs example: 1840.80
- 120 hrs example: 2386.60

Type: 80, 100, 120, or a custom paycheck net.`,
"100"
    );
    if(pick===null) return;
    const v = pick.trim();
    const map = { "80":1391.31, "100":1840.80, "120":2386.60 };
    const amt = map[v] ?? Number(v);
    if(!Number.isFinite(amt) || amt<=0){
      alert("Invalid input. Use 80/100/120 or a positive number.");
      return;
    }
    st.meta.paycheckAmount = amt;
  }

  function simPayoffDebt(debtId){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const d = st.debts.find(x=>x.id===debtId);
    if(!d) return;
    if(d.paidOff || clamp(d.balance)<=0){
      alert("That debt is already paid off (SIM).");
      return;
    }
    const cashCost = clamp(d.balance);
    const ok = confirm(`SIM Payoff now?\n\n${d.name}\nPay: ${money(cashCost)}\nThis will (SIM) remove its minimum from the timeline.`);
    if(!ok) return;

    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(todayNoon()),
      note: `Paid off ${d.name} (SIM)`,
      amount: -cashCost
    });
    d.balance = 0;
    d.paidOff = true;
  }

  function simExtraToDebt(debtId){
    if(!ensureSimOn()) return;
    const st = sim.state;
    const d = st.debts.find(x=>x.id===debtId);
    if(!d) return;
    if(d.paidOff || clamp(d.balance)<=0){
      alert("That debt is already paid off (SIM).");
      return;
    }
    const amtStr = prompt(`Extra payment to "${d.name}" (SIM).\nEnter amount:`, "100");
    if(amtStr===null) return;
    const amt = Number(amtStr);
    if(!Number.isFinite(amt) || amt<=0){
      alert("Enter a positive number.");
      return;
    }
    const pay = Math.min(amt, clamp(d.balance));
    st.adjustments.push({
      id: uid(),
      date: fmtDateInput(todayNoon()),
      note: `Extra to ${d.name} (SIM)`,
      amount: -pay
    });
    d.balance = Math.max(0, clamp(d.balance) - pay);
    if(d.balance === 0) d.paidOff = true;
  }

  // ---------- Share link + QR (Reality only) ----------
  function base64UrlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function base64UrlDecode(b64url){
    let s = b64url.replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    const str = decodeURIComponent(escape(atob(s)));
    return str;
  }
  function getShareFromHash(){
    const h = (location.hash || "").slice(1);
    if(!h) return null;
    // allow "share=..." anywhere in hash
    const parts = h.split("&");
    for(const p of parts){
      const [k,v] = p.split("=");
      if(k === "share" && v) return v;
    }
    return null;
  }
  function clearShareHash(){
    // preserve other hash segments if any (keep simple: wipe hash)
    history.replaceState(null, document.title, location.pathname + location.search);
  }
  function buildShareLinkFromState(st){
    const payload = JSON.stringify(st);
    const enc = base64UrlEncode(payload);
    const base = location.origin + location.pathname + location.search;
    return `${base}#share=${enc}`;
  }

  // ---- Tiny QR generator (canvas) ----
  // This uses an external-free, minimal QR routine (not fancy, but reliable for typical URLs).
  // If the URL is extremely long, QR can fail. In that case, use Export JSON.
  function drawPseudoQR(canvas, text){
    // NOTE: Not a true QR spec encoder. For reliability, we use a lightweight trick:
    // Render a scannable QR via a public, zero-auth endpoint *ONLY if online*.
    // If offline or blocked, we fall back to a readable "copy link" flow.
    //
    // Endpoint: api.qrserver.com (common QR image service).
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0c1324";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const img = new Image();
    const url = "https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=" + encodeURIComponent(text);
    img.crossOrigin = "anonymous";
    img.onload = ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.onerror = ()=>{
      // fallback: show message blocks if QR can't load
      ctx.fillStyle = "#eef2ff";
      ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("QR failed to load.", 18, 40);
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Use Copy Link or Export JSON.", 18, 64);
    };
    img.src = url;
  }

  function openQrModal(link){
    $("qrBack").style.display = "flex";
    drawPseudoQR($("qrCanvas"), link);
  }
  function closeQrModal(){
    $("qrBack").style.display = "none";
  }

  // ---------- Render ----------
  function render(){
    // mode pill + sim controls
    $("modePill").textContent = sim.enabled ? "What if?" : "Reality";
    $("modePill").className = sim.enabled ? "pill purple" : "pill";
    $("simControls").style.display = sim.enabled ? "block" : "none";
    $("timelineModeLabel").textContent = sim.enabled ? "What if?" : "Reality";

    const st = activeState();

    // meta inputs
    $("cashOnHand").value = st.meta.cashOnHand ?? 0;
    $("bufferFloor").value = st.meta.bufferFloor ?? 0;
    $("splitPct").value = String(st.meta.splitPct ?? 0.5);

    $("payFrequency").value = st.meta.payFrequency ?? "biweekly";
    $("paycheckAmount").value = st.meta.paycheckAmount ?? 0;
    $("lastPayday").value = st.meta.lastPayday ?? "";
    $("snowballMonthly").value = st.meta.snowballMonthly ?? 0;
    $("snowballAlloc").value = st.meta.snowballAlloc ?? "per_paycheck";
    $("snowballDay").value = st.meta.snowballDay ?? 20;

    $("strategy").value = st.meta.strategy ?? "snowball";
    updateManualTargets();

    // quick income
    $("quickIncome").value = st.meta.quickIncome ?? 100;

    // toggle snowball day UI
    const alloc = st.meta.snowballAlloc;
    $("snowballDayWrap").style.display = alloc==="monthly_day" ? "block" : "none";
    $("allocHelp").textContent = alloc==="monthly_day" ? "Snowball posts on the chosen day." : "Snowball splits across paychecks inside the timeline.";

    // next payday
    const nxt = nextPaydayFrom(st.meta.lastPayday, st.meta.payFrequency);
    $("nextPayday").value = nxt ? fmtDateInput(nxt) : "";

    // horizon date
    const horizonEnd = horizonEndDateFromUI();

    // snapshots: Reality + What if?
    const rSnap = computeSnapshot(state, horizonEnd);
    const sSnap = computeSnapshot(sim.enabled ? sim.state : state, horizonEnd);

    $("r_safe").textContent = money(rSnap.safe);
    $("r_committed").textContent = money(rSnap.committed);
    $("r_nextpay").textContent = money(rSnap.balAtNextPay);
    $("r_horizon").textContent = money(rSnap.balHorizon);

    $("s_safe").textContent = money(sSnap.safe);
    $("s_committed").textContent = money(sSnap.committed);
    $("s_nextpay").textContent = money(sSnap.balAtNextPay);
    $("s_horizon").textContent = money(sSnap.balHorizon);

    const deltaH = sSnap.balHorizon - rSnap.balHorizon;
    $("delta_horizon").textContent = (deltaH>=0?"+":"") + money(deltaH);
    $("delta_horizon").className = "v mono " + (deltaH>=0 ? "deltaPos" : "deltaNeg");

    const rMin = state.debts.filter(d=>!d.paidOff).reduce((a,d)=>a+clamp(d.min),0);
    const sMin = (sim.enabled ? sim.state : state).debts.filter(d=>!d.paidOff).reduce((a,d)=>a+clamp(d.min),0);
    const freed = rMin - sMin;
    $("delta_minfreed").textContent = (freed>=0?"+":"") + money(freed);
    $("delta_minfreed").className = "v mono " + (freed>=0 ? "deltaPos" : "deltaNeg");

    // health pill (based on active snapshot)
    const activeSnap = sim.enabled ? sSnap : rSnap;
    const hp = $("healthPill");
    if(activeSnap.safe < 0){
      hp.textContent = "Tight (reduce snowball / adjust splits)";
      hp.className = "pill warn";
    } else if(activeSnap.balHorizon < clamp(st.meta.bufferFloor)){
      hp.textContent = "Below buffer by horizon";
      hp.className = "pill bad";
    } else {
      hp.textContent = "Healthy";
      hp.className = "pill good";
    }

    // timeline (next 10) ‚Äî from active state
    const tb = $("timelineTbody");
    tb.innerHTML = "";
    activeSnap.running.slice(0, 10).forEach(ev=>{
      const canQuickPay = (ev.amount < 0) && (ev.type !== "adj");
      const showIncomeBtn = clamp(st.meta.quickIncome) > 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${ev.date.toLocaleDateString()}</td>
        <td>${escapeHtml(ev.label)}</td>
        <td class="right mono">${money(ev.amount)}</td>
        <td class="right mono">${money(ev.balance)}</td>
        <td class="right">
          <div class="row" style="justify-content:flex-end; gap:8px">
            ${showIncomeBtn ? `<button class="btn ghost sm" data-act="quickIncome" data-date="${fmtDateInput(ev.date)}">+ Income</button>` : ``}
            ${canQuickPay ? `<button class="btn sm" data-act="quickPay" data-type="${ev.type}" data-ref="${ev.refId}" data-date="${fmtDateInput(ev.date)}">Quick Pay</button>` : `<span class="small">‚Äî</span>`}
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    // bills table (active state)
    const btb = $("billsTbody");
    btb.innerHTML = "";
    st.bills.forEach(b=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(b.name||"")}</td>
        <td class="right mono">${money(b.amount)}</td>
        <td class="right mono">${escapeHtml(String(b.dueDay||""))}</td>
        <td class="right">
          <input class="chk" type="checkbox" data-act="toggleSplit" data-id="${b.id}" ${b.splitAllowed?"checked":""} />
        </td>
        <td class="right">
          <div class="row" style="justify-content:flex-end; gap:8px">
            <button class="btn sm" data-act="payEarlyBill" data-id="${b.id}">Pay Early</button>
            <button class="btn ghost sm" data-act="editBill" data-id="${b.id}">Edit</button>
            <button class="btn danger sm" data-act="delBill" data-id="${b.id}">Del</button>
          </div>
        </td>
      `;
      btb.appendChild(tr);
    });

    // debts table (active state)
    const dtb = $("debtsTbody");
    dtb.innerHTML = "";
    st.debts.forEach(d=>{
      const tr = document.createElement("tr");
      const simBtns = sim.enabled && !d.paidOff ? `
        <button class="btn sm" data-act="simPayoff" data-id="${d.id}">Payoff (SIM)</button>
        <button class="btn ghost sm" data-act="simExtra" data-id="${d.id}">+ Extra (SIM)</button>
      ` : (sim.enabled ? `<span class="small">‚Äî</span>` : ``);

      tr.innerHTML = `
        <td>
          ${escapeHtml(d.name||"")}
          ${interestLine(d)}
        </td>
        <td class="right mono">${money(d.balance)}</td>
        <td class="right mono">${clamp(d.apr).toFixed(2)}%</td>
        <td class="right mono">${money(d.min)}</td>
        <td class="right mono">${escapeHtml(String(d.dueDay||""))}</td>
        <td class="right"><input class="chk" type="checkbox" data-act="togglePaidDebt" data-id="${d.id}" ${d.paidOff?"checked":""} /></td>
        <td class="right">
          ${simBtns}
          <div style="height:6px"></div>
          <button class="btn ghost sm" data-act="editDebt" data-id="${d.id}">Edit</button>
          <button class="btn danger sm" data-act="delDebt" data-id="${d.id}">Del</button>
        </td>
      `;
      dtb.appendChild(tr);
    });

    $("payoffBox").innerHTML = payoffEstimateText(st);

    // adjustments (active state)
    const atb = $("adjTbody");
    atb.innerHTML = "";
    st.adjustments
      .slice()
      .sort((a,b)=> (parseDateInput(a.date)||0) - (parseDateInput(b.date)||0))
      .forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(a.date||"")}</td>
          <td>${escapeHtml(a.note||"")}</td>
          <td class="right mono">${money(a.amount)}</td>
          <td class="right">
            <button class="btn danger sm" data-act="delAdj" data-id="${a.id}">Del</button>
          </td>
        `;
        atb.appendChild(tr);
      });

    // persist only reality state
    saveState();
  }

  // ---------- Add/Edit prompts ----------
  function addOrEditBill(existing){
    const st = activeState();
    const name = prompt("Bill name:", existing?.name ?? "");
    if(name===null) return;
    const amount = prompt("Monthly amount:", existing?.amount ?? "");
    if(amount===null) return;
    const dueDay = prompt("Due day of month (1-31):", existing?.dueDay ?? "");
    if(dueDay===null) return;
    const splitAllowed = confirm("Split Allowed? (OK = Yes, Cancel = No)");

    const bill = {
      id: existing?.id ?? uid(),
      name: name.trim(),
      amount: Number(amount)||0,
      dueDay: dueDay.trim() ? (Number(dueDay)||"") : "",
      splitAllowed: !!splitAllowed
    };

    if(existing){
      const i = st.bills.findIndex(b=>b.id===existing.id);
      if(i>=0) st.bills[i]=bill;
    } else {
      st.bills.push(bill);
    }
    render();
  }

  function addOrEditDebt(existing){
    const st = activeState();
    const name = prompt("Debt name:", existing?.name ?? "");
    if(name===null) return;
    const balance = prompt("Current balance:", existing?.balance ?? "");
    if(balance===null) return;
    const apr = prompt("APR % (0 if none):", existing?.apr ?? "");
    if(apr===null) return;
    const min = prompt("Monthly minimum payment:", existing?.min ?? "");
    if(min===null) return;
    const dueDay = prompt("Due day of month for minimum (optional):", existing?.dueDay ?? "");
    if(dueDay===null) return;

    const debt = {
      id: existing?.id ?? uid(),
      name: name.trim(),
      balance: Number(balance)||0,
      apr: Number(apr)||0,
      min: Number(min)||0,
      dueDay: dueDay.trim()? (Number(dueDay)||"") : "",
      paidOff: existing?.paidOff ?? false
    };

    if(existing){
      const i = st.debts.findIndex(d=>d.id===existing.id);
      if(i>=0) st.debts[i]=debt;
    } else {
      st.debts.push(debt);
      if(!st.meta.manualTargetId) st.meta.manualTargetId = debt.id;
    }
    render();
  }

  function addAdjustment(){
    const st = activeState();
    const date = prompt("Date (YYYY-MM-DD):", fmtDateInput(todayNoon()));
    if(date===null) return;
    const note = prompt("Note:", "");
    if(note===null) return;
    const amt = prompt("Amount (positive=in, negative=out):", "");
    if(amt===null) return;

    st.adjustments.push({
      id: uid(),
      date: date.trim(),
      note: note.trim() || "Adjustment",
      amount: Number(amt)||0
    });
    render();
  }

  // ---------- Input Wiring ----------
  $("horizonMonths").addEventListener("change", render);

  $("cashOnHand").addEventListener("input", e=>{
    const st = activeState();
    st.meta.cashOnHand = Number(e.target.value)||0;
    render();
  });
  $("bufferFloor").addEventListener("input", e=>{
    const st = activeState();
    st.meta.bufferFloor = Number(e.target.value)||0;
    render();
  });

  $("splitPct").addEventListener("change", e=>{
    const st = activeState();
    st.meta.splitPct = Number(e.target.value)||0.5;
    render();
  });

  $("payFrequency").addEventListener("change", e=>{
    const st = activeState();
    st.meta.payFrequency = e.target.value;
    render();
  });
  $("paycheckAmount").addEventListener("input", e=>{
    const st = activeState();
    st.meta.paycheckAmount = Number(e.target.value)||0;
    render();
  });
  $("lastPayday").addEventListener("change", e=>{
    const st = activeState();
    st.meta.lastPayday = e.target.value||"";
    render();
  });

  $("snowballMonthly").addEventListener("input", e=>{
    const st = activeState();
    st.meta.snowballMonthly = Number(e.target.value)||0;
    render();
  });
  $("snowballAlloc").addEventListener("change", e=>{
    const st = activeState();
    st.meta.snowballAlloc = e.target.value;
    render();
  });
  $("snowballDay").addEventListener("input", e=>{
    const st = activeState();
    st.meta.snowballDay = Number(e.target.value)||20;
    render();
  });

  $("strategy").addEventListener("change", e=>{
    const st = activeState();
    st.meta.strategy = e.target.value;
    render();
  });
  $("manualTarget").addEventListener("change", e=>{
    const st = activeState();
    st.meta.manualTargetId = e.target.value || null;
    render();
  });

  $("quickIncome").addEventListener("input", e=>{
    const st = activeState();
    st.meta.quickIncome = Number(e.target.value)||0;
    render();
  });

  $("addBillBtn").addEventListener("click", ()=> addOrEditBill(null));
  $("addDebtBtn").addEventListener("click", ()=> addOrEditDebt(null));
  $("addAdjBtn").addEventListener("click", ()=> addAdjustment());

  // What if controls
  $("whatIfBtn").addEventListener("click", ()=>{
    if(sim.enabled){
      if(confirm("Exit What if? (sandbox changes will be discarded unless Applied).")) {
        exitWhatIf();
        render();
      }
      return;
    }
    enterWhatIf();
    render();
  });

  $("applySimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Apply What if? changes to Reality? (This will overwrite Reality with the sandbox state.)")) return;
    applyWhatIf();
    render();
  });

  $("resetSimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Reset What if? back to Reality (discard sandbox tinkering)?")) return;
    resetWhatIf();
    render();
  });

  $("exitSimBtn").addEventListener("click", ()=>{
    if(!sim.enabled) return;
    if(!confirm("Exit What if? (discard sandbox changes unless Applied).")) return;
    exitWhatIf();
    render();
  });

  $("simOneOffBtn").addEventListener("click", ()=>{
    if(!ensureSimOn()) return;
    simAddOneOff();
    render();
  });

  $("simWorkPlanBtn").addEventListener("click", ()=>{
    if(!ensureSimOn()) return;
    simWorkPlan();
    render();
  });

  // Share / QR
  $("createLinkBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("Create Link uses Reality data (not What if?). Continue?")) return;
    const link = buildShareLinkFromState(state);
    $("shareLink").value = link;

    // also put it into your current URL hash for quick copy if you want
    // (does NOT import into this device; it's just a link)
    history.replaceState(null, document.title, location.pathname + location.search + "#share=" + link.split("#share=")[1]);

    // If the link is too long, warn
    if(link.length > 3500){
      alert("Heads up: this share link is pretty long. If it fails on some devices, use Export JSON instead.");
    }
  });

  $("copyLinkBtn").addEventListener("click", async ()=>{
    const v = $("shareLink").value || "";
    if(!v){
      alert("Tap Create Link first.");
      return;
    }
    try{
      await navigator.clipboard.writeText(v);
      alert("Link copied.");
    } catch {
      $("shareLink").focus();
      $("shareLink").select();
      document.execCommand("copy");
      alert("Link copied.");
    }
  });

  $("clearLinkBtn").addEventListener("click", ()=>{
    $("shareLink").value = "";
    clearShareHash();
  });

  $("createQrBtn").addEventListener("click", ()=>{
    const v = $("shareLink").value || "";
    if(!v){
      // auto-create if empty
      const link = buildShareLinkFromState(state);
      $("shareLink").value = link;
    }
    openQrModal($("shareLink").value);
  });

  $("closeQrBtn").addEventListener("click", closeQrModal);
  $("qrBack").addEventListener("click", (e)=>{
    if(e.target === $("qrBack")) closeQrModal();
  });

  // ---------- Delegated clicks ----------
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const act = btn.dataset.act;
    const st = activeState();

    // preset quick income
    if(act==="setQuickIncome"){
      const v = Number(btn.dataset.v||0);
      st.meta.quickIncome = v;
      render();
      return;
    }

    // 1-click + Income on timeline row date
    if(act==="quickIncome"){
      const d = parseDateInput(btn.dataset.date);
      if(!d) return;
      if(clamp(st.meta.quickIncome) <= 0){
        alert("Set a Quick Income Amount first.");
        return;
      }
      addQuickIncomeOnDate(st, d, "Timeline");
      render();
      return;
    }

    // Quick Pay from timeline (acts on active state)
    if(act==="quickPay"){
      const type = btn.dataset.type;
      const refId = btn.dataset.ref;
      const date = parseDateInput(btn.dataset.date);
      if(!date) return;

      const horizonEnd = horizonEndDateFromUI();
      const snap = computeSnapshot(st, horizonEnd);
      const found = snap.running.find(ev => ev.type===type && ev.refId===refId && fmtDateInput(ev.date)===fmtDateInput(date));
      if(!found) return;

      // zero prompts not requested for Quick Pay; keep confirm
      const label = sim.enabled ? "Quick Pay (SIM) now?" : "Quick Pay now?";
      if(!confirm(`${label}\n\n${found.label}\n${money(found.amount)}`)) return;
      quickPay(st, found);
      render();
      return;
    }

    const id = btn.dataset.id;

    // Pay Early bill (1-click, zero prompts)
    if(act==="payEarlyBill"){
      payBillEarly(st, id);
      render();
      return;
    }

    // SIM actions
    if(act==="simPayoff"){ simPayoffDebt(id); render(); return; }
    if(act==="simExtra"){ simExtraToDebt(id); render(); return; }

    // bills/debts/adjustments edits
    if(act==="delBill"){ st.bills = st.bills.filter(b=>b.id!==id); render(); return; }
    if(act==="editBill"){ const b = st.bills.find(x=>x.id===id); if(b) addOrEditBill(b); return; }

    if(act==="delDebt"){
      st.debts = st.debts.filter(d=>d.id!==id);
      if(st.meta.manualTargetId===id) st.meta.manualTargetId=null;
      render(); return;
    }
    if(act==="editDebt"){ const d = st.debts.find(x=>x.id===id); if(d) addOrEditDebt(d); return; }

    if(act==="delAdj"){ st.adjustments = st.adjustments.filter(a=>a.id!==id); render(); return; }
  });

  document.addEventListener("change", (e)=>{
    const t = e.target;
    const st = activeState();

    // toggle split on bills
    if(t && t.matches('input[type="checkbox"][data-act="toggleSplit"]')){
      const id = t.dataset.id;
      const b = st.bills.find(x=>x.id===id);
      if(b) b.splitAllowed = !!t.checked;
      render();
    }

    // toggle paid off debt
    if(t && t.matches('input[type="checkbox"][data-act="togglePaidDebt"]')){
      const id = t.dataset.id;
      const d = st.debts.find(x=>x.id===id);
      if(d) d.paidOff = !!t.checked;
      render();
    }
  });

  // Export / Import / Reset (Reality only)
  $("exportBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("You are in What if?. Export will export Reality only. Continue?")) return;
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "autopilot-tracker-v3_2-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  $("importBtn").addEventListener("click", ()=>{
    if(sim.enabled && !confirm("Import replaces Reality. Exit What if? first (recommended). Continue anyway?")) return;
    $("fileInput").click();
  });

  $("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const p = JSON.parse(text);
      state = normalizeState(p);
      saveState();
      if(sim.enabled){
        sim.state = deepClone(state);
      }
      render();
      alert("Import complete.");
    } catch {
      alert("Import failed. Use an exported JSON backup.");
    } finally {
      e.target.value = "";
    }
  });

  $("resetBtn").addEventListener("click", ()=>{
    if(!confirm("Reset all tracker data on this device? This cannot be undone.")) return;
    localStorage.removeItem(KEY);
    state = deepClone(defaultState);
    exitWhatIf();
    render();
  });

  // ---------- Incoming share handling ----------
  function showIncomingShareBanner(){
    $("incomingShareBanner").style.display = "block";
  }
  function hideIncomingShareBanner(){
    $("incomingShareBanner").style.display = "none";
  }

  $("importShareBtn").addEventListener("click", ()=>{
    const enc = getShareFromHash();
    if(!enc){
      hideIncomingShareBanner();
      return;
    }
    try{
      const json = base64UrlDecode(enc);
      const p = JSON.parse(json);
      state = normalizeState(p);
      saveState();
      exitWhatIf();
      render();
      hideIncomingShareBanner();
      clearShareHash();
      alert("Import complete.");
    } catch {
      alert("Import failed (bad/too-long link). Use Export JSON instead.");
      hideIncomingShareBanner();
      // keep hash so user can try again if they want
    }
  });

  $("ignoreShareBtn").addEventListener("click", ()=>{
    hideIncomingShareBanner();
    clearShareHash();
  });

  // Init
  (function init(){
    // detect incoming share link
    const enc = getShareFromHash();
    if(enc){
      showIncomingShareBanner();
      // also prefill shareLink for convenience
      $("shareLink").value = location.href;
    }
    render();
  })();
</script>
</body>
</html>

